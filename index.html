<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Master: v27 Pro (Speaking & Grammar)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f9ff; touch-action: manipulation; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Interactive Transcript Styles */
        .t-segment { cursor: pointer; transition: all 0.2s; padding: 2px 4px; border-radius: 4px; display: inline; line-height: 1.8; margin-right: 4px; }
        .t-segment:hover { background-color: #e0e7ff; color: #4338ca; }
        .t-active { background-color: #fef08a; color: #854d0e; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* Vietnamese Transcript Active State */
        .tv-segment { transition: all 0.2s; border-left: 3px solid transparent; }
        .tv-active { background-color: #fef9c3; color: #854d0e; font-weight: bold; border-left: 3px solid #ca8a04; padding-left: 8px; transform: translateX(4px); }

        /* Animations */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pulse-ring { animation: pulse-ring 2s infinite; }
        
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Audio Player */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #4f46e5; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        
        /* Tabs */
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: bold; background-color: #eef2ff; }
        .tab-inactive { color: #6b7280; hover:text-gray-800; hover:bg-gray-50; }
        
        /* Modal Overlay */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); z-index: 50; }
        #fullScreenLoader { z-index: 100; }
        
        /* API Key Box Animation */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.2s ease-out; }

        /* Pronunciation Card Styles */
        .pronun-card { transition: transform 0.2s; }
        .pronun-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

        /* Admin API Styles */
        .key-item { transition: all 0.2s; }
        .key-status-good { background-color: #dcfce7; border-color: #86efac; color: #166534; }
        .key-status-bad { background-color: #fee2e2; border-color: #fca5a5; color: #991b1b; }
        .key-status-unknown { background-color: #f3f4f6; border-color: #e5e7eb; color: #4b5563; }

        /* Grammar Tree Styles */
        .grammar-tree-item { margin-left: 1rem; padding: 2px 0; font-size: 0.9em; color: #4b5563; }
        .grammar-section-header { cursor: pointer; user-select: none; }
        .grammar-checkbox { accent-color: #991b1b; } /* Red-800 for grammar theme */

        /* Vocab Tooltip */
        .vocab-option:hover::after {
            content: attr(data-meaning);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            opacity: 0.9;
            pointer-events: none;
        }

        /* Reading Hints */
        .reading-hint-box { border-left: 3px solid #f59e0b; background-color: #fffbeb; padding: 8px; font-size: 0.85em; margin-top: 8px; display: none; }
    </style>
</head>
<body class="h-screen flex flex-col items-center p-2 sm:p-4 bg-gradient-to-br from-blue-50 to-indigo-50 overflow-hidden" onload="initApp()">

    <!-- API KEY & ADMIN TOOL -->
    <div id="apiKeyContainer" class="fixed bottom-4 left-4 z-50 flex flex-col items-start">
        <div id="apiKeyInputBox" class="hidden bg-white p-3 rounded-lg shadow-xl border border-gray-200 mb-2 w-80 animate-fade-in-up relative max-h-[80vh] flex flex-col">
            <div class="absolute -bottom-1 left-4 w-2 h-2 bg-white transform rotate-45 border-b border-r border-gray-200"></div>
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-2 flex-shrink-0">
                <label class="text-xs font-bold text-gray-700 flex items-center">
                    <i class="fas fa-key text-yellow-500 mr-1.5"></i> Cấu hình API
                </label>
                <div class="flex space-x-2">
                    <button onclick="toggleAdminPanel()" class="text-[10px] text-indigo-600 hover:underline font-bold" id="btnAdminToggle">Admin Login</button>
                    <button onclick="toggleApiKeyBox()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <!-- Standard User View (Manual Input) -->
            <div id="userApiView" class="mb-2">
                <input type="password" id="userApiKeyInput" class="w-full p-2 border border-gray-300 rounded text-xs mb-2 focus:outline-none focus:border-indigo-500 font-mono text-gray-600" placeholder="Nhập Key thủ công (nếu có)...">
                <button onclick="saveUserApiKey()" class="w-full bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700 shadow-sm">Lưu Key Cá Nhân</button>
            </div>

            <!-- Admin Login View -->
            <div id="adminLoginView" class="hidden border-t border-gray-100 pt-2">
                <p class="text-[10px] text-gray-500 mb-1">Nhập mật khẩu quản trị để mở kho Key:</p>
                <div class="flex space-x-1 mb-1">
                    <input type="password" id="adminPassInput" class="flex-1 p-2 border border-gray-300 rounded text-xs focus:outline-none focus:border-indigo-500" placeholder="Password...">
                    <button onclick="checkAdminLogin()" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-700">Mở</button>
                </div>
                <button onclick="backToUserView()" class="w-full text-gray-500 hover:bg-gray-100 py-1 rounded text-[10px] border border-gray-200 bg-gray-50 transition"><i class="fas fa-arrow-left mr-1"></i> Quay lại nhập thủ công</button>
                <p id="adminLoginMsg" class="text-[10px] text-red-500 mt-1 hidden">Sai mật khẩu!</p>
            </div>

            <!-- Admin Dashboard (Unlocked) -->
            <div id="adminDashboard" class="hidden flex-col flex-1 min-h-0 border-t border-gray-100 pt-2 mt-1">
                <div class="flex justify-between items-center mb-2 bg-indigo-50 p-2 rounded">
                    <div class="flex items-center">
                        <button onclick="backToUserView()" class="mr-2 text-indigo-400 hover:text-indigo-700 transition" title="Thoát ra nhập tay"><i class="fas fa-arrow-left"></i></button>
                        <span class="text-[10px] font-bold text-indigo-800"><i class="fas fa-robot mr-1"></i>Auto Mode</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggleAutoRotate" class="sr-only peer" onchange="toggleAutoMode(this.checked)">
                        <div class="w-7 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                </div>

                <div class="flex-1 overflow-y-auto mb-2 border border-gray-100 rounded bg-gray-50 p-1 custom-scrollbar max-h-40">
                    <ul id="adminKeyList" class="space-y-1"></ul>
                </div>

                <div class="flex space-x-1 mt-auto pt-2 border-t border-gray-100">
                    <input type="text" id="newKeyInput" class="flex-1 p-1.5 border border-gray-300 rounded text-[10px] font-mono" placeholder="Thêm Key mới...">
                    <button onclick="addNewKey()" class="bg-green-600 text-white px-2 py-1 rounded text-[10px] font-bold hover:bg-green-700"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
        <button onclick="toggleApiKeyBox()" class="w-10 h-10 bg-gray-900 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-800 transition ring-2 ring-white" title="Cài đặt API Key">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <!-- FULL SCREEN LOADER -->
    <div id="fullScreenLoader" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center text-white transition-opacity">
        <div class="w-16 h-16 border-4 border-t-pink-500 border-b-pink-500 border-l-transparent border-r-transparent rounded-full animate-spin mb-4"></div>
        <h3 id="loaderText" class="text-xl font-bold">Đang xử lý...</h3>
        <p class="text-sm text-gray-300 mt-2">Đang kết nối tới máy chủ AI...</p>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity z-50">Thông báo</div>

    <!-- AUDIO GENERATOR MODAL -->
    <div id="audioGenModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 flex flex-col max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-microphone-alt mr-2 text-pink-600"></i>Tạo Audio Tự Động (AI)</h3>
                <button onclick="closeAudioGenModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chế độ</label>
                    <div class="flex space-x-2">
                        <button onclick="setAudioGenMode('topic')" id="btnModeTopic" class="flex-1 py-2 border-2 border-pink-500 bg-pink-50 text-pink-700 rounded-lg font-bold text-sm transition">Chủ đề (Giải trí)</button>
                        <button onclick="setAudioGenMode('text')" id="btnModeText" class="flex-1 py-2 border-2 border-gray-200 text-gray-500 rounded-lg font-bold text-sm hover:border-pink-300 transition">Từ Văn bản</button>
                        <button onclick="setAudioGenMode('exam')" id="btnModeExam" class="flex-1 py-2 border-2 border-gray-200 text-gray-500 rounded-lg font-bold text-sm hover:border-pink-300 transition">Luyện Đề (Tryhard)</button>
                    </div>
                </div>
                
                <!-- VOICE CONFIGURATION -->
                <div class="flex space-x-2 bg-gray-50 p-3 rounded border border-gray-200">
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Giọng Đọc</label>
                        <select id="genVoice" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:border-pink-500 outline-none">
                            <option value="Aoede" selected>Aoede (Nữ - Mặc định)</option>
                            <option value="Charon">Charon (Nam)</option>
                            <option value="Kore">Kore (Nữ)</option>
                            <option value="Fenrir">Fenrir (Nam Trầm)</option>
                            <option value="Puck">Puck (Nữ Vui)</option>
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Accent (Kiểu)</label>
                        <select id="genAccent" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:border-pink-500 outline-none">
                            <option value="" selected>Mỹ (US - Default)</option>
                            <option value="British">Anh - Anh (UK)</option>
                            <option value="Australian">Úc (Australia)</option>
                            <option value="Indian">Ấn Độ (Indian)</option>
                        </select>
                    </div>
                </div>

                <div id="inputTopicArea">
                    <div class="flex space-x-2 mb-2">
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Thời lượng</label>
                            <select id="genDuration" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:border-pink-500 outline-none">
                                <option value="1">1 Phút</option>
                                <option value="2">2 Phút</option>
                                <option value="3">3 Phút</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Độ khó</label>
                            <select id="genDifficulty" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:border-pink-500 outline-none">
                                <option value="easy">Dễ</option>
                                <option value="medium" selected>Trung bình</option>
                                <option value="hard">Khó</option>
                            </select>
                        </div>
                    </div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chủ đề (Topic)</label>
                    <div class="relative">
                        <input type="text" id="genTopic" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:border-pink-500 outline-none pr-10" placeholder="Nhập hoặc bấm gợi ý...">
                        <button onclick="suggestTrendingTopics('audio')" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-pink-500 hover:text-pink-700" title="Gợi ý chủ đề Trend"><i class="fas fa-magic"></i></button>
                    </div>
                    <div id="audioTrendSuggestions" class="mt-2 flex flex-wrap gap-2 hidden"></div>
                </div>

                <div id="inputExamArea" class="hidden space-y-2">
                    <div class="flex space-x-2">
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kỳ thi</label>
                            <select id="examType" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:border-pink-500 outline-none">
                                <option value="IELTS">IELTS Listening</option>
                                <option value="TOEIC">TOEIC Listening</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phần (Part)</label>
                            <select id="examPart" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:border-pink-500 outline-none">
                                <option value="1">Part 1 (Dễ/Hội thoại)</option>
                                <option value="2">Part 2 (Độc thoại)</option>
                                <option value="3">Part 3 (Hội thoại khó)</option>
                                <option value="4">Part 4 (Học thuật)</option>
                            </select>
                        </div>
                    </div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chủ đề bài thi</label>
                    <div class="relative">
                        <input type="text" id="examTopic" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:border-pink-500 outline-none pr-10" placeholder="VD: Enrollment, Travel booking...">
                        <button onclick="suggestTrendingTopics('audio_exam')" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-pink-500 hover:text-pink-700" title="Gợi ý chủ đề Luyện thi"><i class="fas fa-magic"></i></button>
                    </div>
                     <div id="audioExamSuggestions" class="mt-2 flex flex-wrap gap-2 hidden"></div>
                </div>

                <div id="inputTextArea" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Văn bản cần đọc</label>
                    <textarea id="genText" class="w-full h-32 p-3 border border-gray-300 rounded-lg text-sm focus:border-pink-500 outline-none" placeholder="Dán văn bản tiếng Anh vào đây..."></textarea>
                </div>
                <button onclick="executeAudioGeneration()" id="btnExecuteGen" class="w-full bg-pink-600 hover:bg-pink-700 text-white py-3 rounded-lg font-bold shadow-md transition flex items-center justify-center transform active:scale-95"><i class="fas fa-wand-magic-sparkles mr-2"></i> Tạo Audio & Nghe Ngay</button>
            </div>
        </div>
    </div>

    <!-- READING MODAL (UPDATED) -->
    <div id="readingModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 flex flex-col max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-book-open mr-2 text-green-600"></i>Luyện Reading Pro (AI)</h3>
                <button onclick="document.getElementById('readingModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="readModeAuto" class="space-y-3">
                <!-- Exam Type Selection -->
                <div class="flex space-x-2">
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chứng chỉ</label>
                        <select id="readExamType" onchange="updateReadParts()" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white font-bold text-gray-700">
                            <option value="TOEIC">TOEIC</option>
                            <option value="IELTS">IELTS</option>
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phần thi (Part)</label>
                        <select id="readExamPart" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chủ đề (Topic)</label>
                    <div class="relative">
                        <input type="text" id="readTopic" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:border-green-500 outline-none pr-10" placeholder="VD: Environment, Business...">
                        <button onclick="suggestTrendingTopics('reading')" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-green-500 hover:text-green-700" title="Gợi ý chủ đề Trend">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                    <div id="readTrendSuggestions" class="mt-2 flex flex-wrap gap-2 hidden"></div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Độ khó</label>
                    <select id="readLevel" class="w-full p-3 border border-gray-300 rounded-lg text-sm bg-white">
                        <option value="easy">Easy (Dễ)</option>
                        <option value="medium" selected>Medium (Trung bình)</option>
                        <option value="hard">Hard (Khó - Nâng cao)</option>
                    </select>
                </div>
                
                <div class="bg-blue-50 p-2 rounded text-[10px] text-blue-800 border border-blue-100 italic">
                    <i class="fas fa-lightbulb mr-1 text-yellow-500"></i> AI sẽ tạo bài đọc kèm:
                    <ul class="list-disc ml-4 mt-1">
                        <li>Cách tư duy (Skimming/Scanning)</li>
                        <li>Từ khóa (Keywords) trong bài</li>
                        <li>Gợi ý mớm ý (Scaffolding hints)</li>
                    </ul>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-100">
                <button onclick="generateReadingTask()" id="btnGenReading" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-md transition flex items-center justify-center transform active:scale-95">
                    <i class="fas fa-magic mr-2 text-yellow-300"></i> Tạo Đề & Chấm Điểm
                </button>
            </div>
        </div>
    </div>

    <!-- SETUP MODAL (Simple Text Edit) -->
    <div id="setupModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Chỉnh sửa Transcript Gốc</h3>
                <button onclick="closeSetupModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-xs text-gray-500 mb-2">Chỉnh sửa nội dung gốc ở đây. Hệ thống sẽ tự động đồng bộ lại vào khung Realtime.</p>
            <textarea id="targetText" class="w-full h-32 p-3 border border-gray-300 rounded-lg mb-3 text-sm focus:outline-none focus:border-indigo-500 shadow-inner" placeholder="Dán văn bản vào đây..."></textarea>
            <div class="flex justify-end space-x-2">
                <button onclick="saveTranscript()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 text-sm">Lưu & Đồng bộ</button>
                <button onclick="closeSetupModal()" class="text-gray-600 hover:bg-gray-100 px-4 py-2 border border-gray-300 rounded-lg text-sm">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="w-full max-w-7xl flex flex-col mb-2 flex-shrink-0">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800"><i class="fas fa-layer-group mr-2 text-indigo-600"></i>English Master <span class="text-xs bg-indigo-600 text-white px-2 py-0.5 rounded-full ml-1">v27 Pro</span></h1>
            
            <div id="audioUploadContainer" class="flex space-x-2 items-center">
                <button onclick="openAudioGenModal()" class="bg-pink-100 border border-pink-200 hover:bg-pink-200 text-pink-700 px-3 py-1.5 rounded-lg shadow-sm text-sm font-bold transition flex items-center">
                    <i class="fas fa-microphone-lines mr-2"></i> Audio AI
                </button>
                <div class="relative">
                    <input type="file" id="audioInput" accept="audio/*" class="hidden" onchange="handleAudioUpload(event)">
                    <label for="audioInput" class="cursor-pointer bg-white border border-indigo-200 hover:bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg shadow-sm text-sm font-bold transition flex items-center">
                        <i class="fas fa-upload mr-2"></i> Upload
                    </label>
                </div>
                <!-- AUDIO DOWNLOAD BUTTON -->
                <a id="downloadAudioBtn" class="hidden bg-green-100 border border-green-200 hover:bg-green-200 text-green-700 px-3 py-1.5 rounded-lg shadow-sm text-sm font-bold transition flex items-center cursor-pointer" download="Audio_Master.wav" title="Tải Audio">
                    <i class="fas fa-download"></i>
                </a>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex overflow-x-auto border-b border-gray-200 no-scrollbar">
            <button onclick="switchTab('dictation')" id="tabDictation" class="tab-active px-4 py-2 transition whitespace-nowrap text-sm sm:text-base">
                <i class="fas fa-pencil-alt mr-1"></i> Dictation
            </button>
            <button onclick="switchTab('deep')" id="tabDeep" class="tab-inactive px-4 py-2 transition whitespace-nowrap text-sm sm:text-base text-purple-600">
                <i class="fas fa-brain mr-1"></i> Deep Drill
            </button>
            <button onclick="switchTab('quiz')" id="tabQuiz" class="tab-inactive px-4 py-2 transition whitespace-nowrap text-sm sm:text-base">
                <i class="fas fa-headphones mr-1"></i> Listening
            </button>
            <button onclick="switchTab('reading')" id="tabReading" class="tab-inactive px-4 py-2 transition whitespace-nowrap text-sm sm:text-base">
                <i class="fas fa-book-open mr-1"></i> Reading
            </button>
            <button onclick="switchTab('writing')" id="tabWriting" class="tab-inactive px-4 py-2 transition whitespace-nowrap text-sm sm:text-base text-orange-600">
                <i class="fas fa-pen-nib mr-1"></i> Writing
            </button>
            <button onclick="switchTab('pronun')" id="tabPronun" class="tab-inactive px-4 py-2 transition whitespace-nowrap text-sm sm:text-base text-teal-600">
                <i class="fas fa-microphone-alt mr-1"></i> Speaking
            </button>
            <button onclick="switchTab('grammar')" id="tabGrammar" class="tab-inactive px-4 py-2 transition whitespace-nowrap text-sm sm:text-base text-red-800">
                <i class="fas fa-list-check mr-1"></i> Grammar
            </button>
            <button onclick="switchTab('vocab')" id="tabVocab" class="tab-inactive px-4 py-2 transition whitespace-nowrap text-sm sm:text-base text-cyan-700">
                <i class="fas fa-shapes mr-1"></i> Vocabulary
            </button>
        </div>
    </div>

    <!-- CONTENT AREA -->
    <div class="flex-1 w-full max-w-7xl relative overflow-hidden bg-white rounded-xl shadow-xl border border-gray-100 flex flex-col">
        
        <!-- AUDIO PLAYER (Global) -->
        <div id="audioPlayerBar" class="bg-gray-900 text-white p-3 sm:p-4 flex-shrink-0 z-10 transition-all duration-300">
            <div class="flex justify-between items-center mb-3">
                <div class="text-xs text-gray-400 truncate w-2/3 flex items-center">
                    <i class="fas fa-music mr-2"></i> <span id="fileNameDisplay">Chưa chọn file audio</span>
                </div>
                <div class="text-xs font-mono text-indigo-300"><span id="currentTime">0:00</span> / <span id="duration">0:00</span></div>
            </div>
            <div class="relative w-full h-1 bg-gray-700 rounded mb-4 group cursor-pointer">
                <div id="progressBar" class="absolute top-0 left-0 h-full bg-indigo-500 rounded w-0 transition-all duration-100"></div>
                <div id="hintSegment" class="absolute top-0 h-full bg-yellow-400 opacity-0 transition-opacity pointer-events-none z-0"></div>
                <input type="range" id="seekSlider" min="0" max="100" value="0" class="absolute top-[-6px] left-0 w-full h-4 opacity-0 cursor-pointer z-10">
            </div>
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <button onclick="rewind(5)" class="text-gray-400 hover:text-white transition"><i class="fas fa-undo-alt"></i> 5s</button>
                    <button onclick="togglePlay()" id="playBtn" class="w-10 h-10 bg-indigo-600 hover:bg-indigo-500 rounded-full flex items-center justify-center text-white shadow-lg transform active:scale-95 transition">
                        <i class="fas fa-play ml-1"></i>
                    </button>
                    <button onclick="forward(5)" class="text-gray-400 hover:text-white transition"><i class="fas fa-redo-alt"></i> 5s</button>
                </div>
                
                <div class="flex items-center">
                    <!-- Loop Toggle -->
                    <div class="flex items-center mr-4 border-r border-gray-600 pr-4">
                        <span class="text-[10px] uppercase font-bold text-gray-400 mr-2">Loop</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="loopToggle" class="sr-only peer" onchange="toggleLoop()">
                            <div class="w-7 h-4 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-indigo-500"></div>
                        </label>
                    </div>

                    <div class="flex items-center space-x-2">
                        <select id="speedSelect" onchange="changeSpeed()" class="bg-gray-800 text-xs text-white border border-gray-700 rounded px-1 py-0.5 outline-none">
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 1: DICTATION -->
        <div id="viewDictation" class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- LEFT: Realtime Transcript -->
            <div class="w-full md:w-1/2 p-4 bg-gray-50 flex flex-col overflow-hidden border-r border-gray-200 order-2 md:order-1 transition-all">
                <div class="flex justify-between items-center mb-2 flex-shrink-0">
                    <h3 class="text-xs font-bold text-gray-500 uppercase flex items-center">
                        <i class="fas fa-stream mr-2 text-indigo-500"></i> Transcript
                    </h3>
                    <div class="flex space-x-1 items-center">
                         <button onclick="toggleTranscriptVisibility()" id="btnToggleTranscript" class="text-xs bg-gray-100 border border-gray-300 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition mr-2 flex items-center">
                            <i class="fas fa-eye mr-1"></i> Hiện Transcript
                        </button>
                        <div class="flex bg-gray-200 rounded p-0.5 mr-2">
                             <button onclick="toggleTranscriptLang('en')" id="btnTransEn" class="text-[10px] px-2 py-0.5 rounded bg-white text-gray-800 font-bold shadow-sm transition">EN</button>
                             <button onclick="toggleTranscriptLang('vi')" id="btnTransVi" class="text-[10px] px-2 py-0.5 rounded text-gray-500 hover:text-gray-700 transition">VI</button>
                        </div>
                        <button onclick="generateTranscriptFromAI()" class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-2 py-1 rounded transition" title="Tạo Transcript AI">
                            <i class="fas fa-magic"></i> AI
                        </button>
                        <button onclick="openSetupModal()" class="text-xs bg-white border border-gray-300 hover:bg-gray-100 text-gray-600 px-2 py-1 rounded transition">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
                <!-- Wrapper for Hide/Show -->
                <div id="transcriptWrapper" class="flex-1 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-inner text-gray-700 text-sm md:text-base leading-relaxed relative hidden">
                    <div id="transcriptPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 p-6 text-center">
                        <i class="fas fa-wave-square text-3xl mb-2 text-gray-300"></i>
                        <p>Chưa có dữ liệu Realtime.</p>
                        <p class="text-xs mt-1">Bấm <strong>"Tạo AI"</strong> hoặc nhập thủ công.</p>
                    </div>
                    <div id="transcriptContent" class="space-y-4 p-4"></div>
                    <div id="transcriptTranslation" class="space-y-4 hidden text-indigo-800 p-4"></div>
                </div>
                <!-- Mask for Hidden State -->
                <div id="transcriptHiddenMask" class="flex-1 flex flex-col items-center justify-center bg-gray-100 border border-gray-200 rounded-lg text-gray-400">
                    <i class="fas fa-eye-slash text-3xl mb-2"></i>
                    <p class="text-sm">Transcript đang ẩn</p>
                    <p class="text-xs">Tập trung nghe và chép lại bên phải.</p>
                </div>

                <div class="mt-3 bg-blue-50 p-2 rounded border border-blue-100 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-blue-700 mr-2">Xuất Deep Drill:</span>
                        <select id="exportLevelDictation" class="text-xs p-1 border border-blue-200 rounded flex-1 mr-2">
                            <option value="all">A1-C2 (Tất cả)</option>
                            <option value="b1">B1-C2 (Trung cấp+)</option>
                            <option value="b2">B2-C2 (Nâng cao)</option>
                        </select>
                        <button onclick="exportDeepDrill('targetText', 'exportLevelDictation')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700 whitespace-nowrap"><i class="fas fa-file-export"></i> CSV</button>
                    </div>
                </div>
            </div>
            <!-- RIGHT: Input -->
            <div class="w-full md:w-1/2 p-4 bg-white flex flex-col overflow-hidden order-1 md:order-2">
                <div class="flex justify-between mb-2 flex-shrink-0">
                    <label class="text-xs font-bold text-gray-500 uppercase">Bài làm của bạn:</label>
                    <span id="wordCount" class="text-xs text-gray-400">0 từ</span>
                </div>
                <textarea id="userTyping" class="flex-1 w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:outline-none resize-none font-medium text-gray-700 text-lg leading-relaxed shadow-inner mb-3" placeholder="Nghe và chép lại..." oninput="updateWordCount()"></textarea>
                <div class="flex space-x-2 flex-shrink-0 mb-3">
                    <button onclick="checkResult()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2.5 rounded-lg font-bold shadow-md transition text-sm flex items-center justify-center">
                        <i class="fas fa-check-circle mr-2"></i> Chấm điểm
                    </button>
                    <button onclick="analyzeWithAI()" id="btnAnalyze" class="flex-1 bg-white border border-indigo-200 text-indigo-600 py-2.5 rounded-lg font-bold text-xs shadow-sm hover:bg-indigo-50">
                        <i class="fas fa-microscope mr-1"></i> Phân tích lỗi (AI)
                    </button>
                </div>
                <div id="dictationResultPanel" class="flex-1 overflow-y-auto border-t border-gray-100 pt-2 hidden flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700 text-sm">So sánh kết quả</h3>
                        <div id="scoreBadge" class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">--%</div>
                    </div>
                    <div id="diffOutput" class="text-sm leading-relaxed text-gray-600"></div>
                    <div id="aiResultDictation" class="hidden mt-2 text-xs text-gray-700 bg-gray-50 p-2 rounded border border-gray-200"></div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: DEEP DRILL -->
        <div id="viewDeep" class="hidden flex-1 flex flex-col bg-gray-50 overflow-hidden relative">
            <div class="w-full p-4 border-b border-gray-200 bg-white flex justify-between items-center flex-shrink-0 shadow-sm z-10">
                <div class="flex items-center">
                    <div class="font-semibold text-gray-600 flex items-center text-sm mr-4">
                        <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs mr-2 font-bold">NHÓM</span>
                        <span id="deepGroupCounter">--/--</span>
                        <div class="ml-2 flex items-center bg-gray-100 rounded px-2">
                            <span class="text-xs text-gray-500 mr-1">Go:</span>
                            <input type="number" id="deepJumpInput" min="1" class="w-10 text-xs bg-transparent outline-none font-bold text-gray-700" onchange="jumpToDeepChallenge(this.value)">
                        </div>
                    </div>
                    <div class="font-semibold text-gray-600 text-sm">
                        <span class="text-green-600 mr-2"><i class="fas fa-check"></i> <span id="deepScoreCorrect">0</span></span>
                        <span class="text-red-500"><i class="fas fa-times"></i> <span id="deepScoreWrong">0</span></span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="deepResetProgress()" id="btnDeepReset" class="hidden text-red-500 hover:bg-red-50 px-2 py-1 rounded text-xs font-bold transition">Reset</button>
                    <div class="relative group">
                        <input type="file" id="deepCsvInput" accept=".csv" class="hidden" onchange="handleDeepFileUpload(event)">
                        <label for="deepCsvInput" class="cursor-pointer bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg shadow-sm text-xs font-bold transition flex items-center">
                            <i class="fas fa-file-csv mr-2"></i> Tải CSV
                        </label>
                    </div>
                </div>
            </div>
            <div class="w-full bg-gray-200 h-1 flex-shrink-0">
                <div id="deepProgressBar" class="bg-purple-600 h-1 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div id="deepGameArea" class="flex-1 p-4 overflow-y-auto flex flex-col items-center justify-start hidden">
                <div class="w-full text-center mb-4 flex-shrink-0">
                    <div id="deepTypeBadge" class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-2 bg-blue-100 text-blue-800">Từ vựng</div>
                    <h2 class="text-gray-500 text-sm italic">Nghe và viết lại từ sau (hoặc phát âm)</h2>
                </div>
                <div class="flex flex-col items-center w-full max-w-lg relative">
                    <button onclick="playDeepAudio()" class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white shadow-xl flex items-center justify-center transition transform active:scale-95 ring-4 ring-purple-50 focus:outline-none z-10 mb-2">
                        <i class="fas fa-volume-up text-3xl"></i>
                    </button>
                    <div id="deepLargeResult" class="h-auto min-h-[3rem] mt-2 mb-2 flex flex-col items-center justify-center w-full"></div>
                    <div id="deepSpeakingControls" class="w-full flex flex-col items-center mb-4 slide-in">
                        <button id="btnDeepSpeak" onclick="toggleDeepSpeech()" class="flex items-center space-x-2 bg-white border-2 border-purple-200 text-purple-600 hover:bg-purple-50 px-6 py-2 rounded-full font-bold shadow-sm transition transform active:scale-95 text-sm">
                            <i class="fas fa-microphone-alt text-lg"></i>
                            <span id="btnDeepSpeakText">Bấm để nói</span>
                        </button>
                        <div id="deepSpeechResult" class="hidden mt-2 text-center w-full bg-white p-2 rounded border border-purple-100 shadow-sm">
                            <div class="text-[10px] text-gray-400">Bạn nói:</div>
                            <div id="deepSpokenText" class="font-bold text-gray-800 text-lg break-words">...</div>
                            <div id="deepSpeechFeedback" class="text-xs font-bold mt-1"></div>
                        </div>
                    </div>
                    <div class="w-full relative mt-1">
                        <form onsubmit="handleDeepSubmit(event)" action="javascript:void(0);">
                            <input type="text" id="deepInput" placeholder="Nhập từ nghe được..." class="w-full text-center text-xl p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition text-gray-700 font-bold placeholder-gray-300 shadow-inner" autocomplete="off" spellcheck="false" oninput="this.classList.remove('border-red-500', 'bg-red-50')">
                        </form>
                    </div>
                    <div class="flex space-x-1.5 mt-4 mb-2 flex-wrap justify-center" id="deepStepDots"></div>
                    <div id="deepFeedbackArea" class="hidden w-full bg-white p-4 rounded-xl border border-gray-200 slide-in text-left mt-4 shadow-sm">
                        <div class="flex flex-col gap-2 text-sm border-b border-gray-100 pb-2 mb-2">
                            <div class="flex"><span class="w-16 font-bold text-gray-400 text-xs pt-1 uppercase">Nghĩa:</span> <span id="deepMeaningDisplay" class="text-gray-800 font-medium text-lg"></span></div>
                            <div class="flex hidden" id="deepRootRow"><span class="w-16 font-bold text-gray-400 text-xs pt-1 uppercase">Gốc:</span> <span id="deepRootDisplay" class="text-purple-600 font-medium"></span></div>
                        </div>
                        <div id="deepSynonymSection" class="hidden">
                            <div class="flex items-center mb-2"><i class="fas fa-exchange-alt text-orange-500 mr-2 text-xs"></i><span class="text-xs font-bold text-orange-600 uppercase">Giải thích thêm</span></div>
                            <ul id="deepSynonymList" class="text-sm text-gray-700 space-y-1.5"></ul>
                        </div>
                    </div>
                    <div class="flex space-x-2 w-full justify-center mt-4 mb-8">
                        <button onclick="checkDeepAnswer()" id="btnDeepCheck" class="flex-1 max-w-[200px] bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-md transition transform active:scale-95 text-lg">Kiểm tra</button>
                        <button onclick="skipDeepChallenge()" id="btnDeepSkip" class="px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition shadow-sm text-sm">Bỏ qua</button>
                        <button onclick="nextDeepChallenge()" id="btnDeepNext" class="hidden flex-1 max-w-[200px] bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-md transition transform active:scale-95 text-lg">Tiếp tục <i class="fas fa-arrow-right ml-1"></i></button>
                        <button onclick="toggleDeepHint()" class="px-4 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-xl transition shadow-sm"><i class="far fa-lightbulb text-xl"></i></button>
                    </div>
                    <div id="deepHintArea" class="hidden text-sm text-center text-gray-500 bg-yellow-50 px-3 py-2 rounded-lg border border-yellow-200 mt-1"><span id="deepHintText">...</span></div>
                </div>
            </div>
            <div id="deepEmptyState" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
                <div class="w-24 h-24 bg-purple-50 rounded-full flex items-center justify-center mb-4"><i class="fas fa-file-csv text-4xl text-purple-300"></i></div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">Chưa có dữ liệu</h3>
                <p class="text-gray-500 mb-6 text-sm max-w-xs">Tải file CSV chứa từ vựng để bắt đầu luyện tập sâu (Nghe, Nói, Viết).</p>
                <button onclick="document.getElementById('deepCsvInput').click()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition shadow-lg">Tải file CSV ngay</button>
            </div>
            <div id="deepEndScreen" class="hidden absolute inset-0 bg-white z-20 flex flex-col items-center justify-center p-8 fade-in">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 text-4xl shadow-lg"><i class="fas fa-trophy"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Hoàn thành!</h2>
                <button onclick="deepRestart(true)" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-purple-700 transition shadow-md mt-4">Học lại</button>
            </div>
        </div>

        <!-- VIEW 3: AUDIO QUIZ (LISTENING) -->
        <div id="viewQuiz" class="hidden flex-1 flex flex-col bg-gray-50 overflow-y-auto">
            <div class="w-full max-w-4xl mx-auto p-4 flex flex-col min-h-full">
                <div id="quizGenerator" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"><i class="fas fa-headphones text-2xl text-white"></i></div>
                    <h2 class="text-lg font-bold text-gray-800">Listening Practice</h2>
                    <p class="text-xs text-gray-500 mb-4" id="quizDurationHint">...</p>
                    <button onclick="generateQuiz()" id="btnGenQuiz" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md transition flex items-center justify-center"><i class="fas fa-bolt mr-2 text-yellow-300"></i> Tạo câu hỏi ngay</button>
                </div>
                <div id="quizContent" class="hidden space-y-6 pb-10">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                        <h3 class="font-bold text-gray-800">Câu hỏi</h3>
                        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold" id="quizCountBadge">0 câu</span>
                    </div>
                    <div id="questionsList" class="space-y-4"></div>
                    <div class="text-center pt-4">
                        <button onclick="checkQuizAll()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full font-bold shadow-lg uppercase text-sm">Nộp bài</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 4: READING -->
        <div id="viewReading" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden bg-gray-50">
            <div class="flex-1 p-6 md:p-8 overflow-y-auto bg-white border-r border-gray-200">
                <div id="readingPlaceholder" class="h-full flex flex-col items-center justify-center text-gray-400">
                    <i class="fas fa-book-reader text-6xl mb-4 text-gray-200"></i>
                    <p class="mb-4 font-medium">Chưa có bài đọc nào.</p>
                    <button onclick="document.getElementById('readingModal').classList.remove('hidden')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full font-bold shadow-lg transition transform active:scale-95">
                        <i class="fas fa-plus mr-2"></i> Tạo Bài Đọc Mới
                    </button>
                </div>
                <div id="readingDisplay" class="hidden reading-content text-gray-800 text-lg mb-6 leading-relaxed"></div>
                <!-- Reading Action Bar -->
                <div id="readingActionBar" class="hidden mb-6 flex flex-wrap gap-2 justify-end">
                    <button onclick="exportReadingToWord()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm transition flex items-center">
                        <i class="fas fa-file-word mr-2"></i> Xuất Word (Đề & Đáp án)
                    </button>
                    <button onclick="exportReadingToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm transition flex items-center">
                        <i class="fas fa-file-excel mr-2"></i> Xuất Excel (Từ vựng)
                    </button>
                </div>
                
                <div id="readingExportUI" class="hidden mb-6 p-3 bg-blue-50 rounded border border-blue-100 flex items-center justify-between">
                    <div class="flex items-center space-x-2 w-full">
                        <span class="text-xs font-bold text-blue-700 whitespace-nowrap">Xuất từ vựng cho Deep Drill:</span>
                        <select id="exportLevelReading" class="text-xs p-1.5 border border-blue-200 rounded flex-1">
                            <option value="all">A1-C2 (Tất cả)</option>
                            <option value="b1">B1-C2 (Trung cấp+)</option>
                            <option value="b2" selected>B2-C2 (Nâng cao)</option>
                        </select>
                        <button onclick="exportDeepDrillFromReading()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-blue-700 whitespace-nowrap"><i class="fas fa-file-export mr-1"></i> Xuất CSV</button>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-[400px] lg:w-[450px] bg-gray-50 flex flex-col border-l border-gray-200 flex-shrink-0">
                <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-10">
                    <h3 class="font-bold text-gray-800"><i class="fas fa-question-circle mr-2 text-green-600"></i>Câu hỏi Đọc hiểu</h3>
                    <button onclick="document.getElementById('readingModal').classList.remove('hidden')" class="text-xs text-green-600 hover:underline font-bold">Tạo bài khác</button>
                </div>
                <div id="readingQuizContainer" class="flex-1 overflow-y-auto p-4 space-y-6">
                    <div class="text-center text-gray-400 mt-10 text-sm italic">Câu hỏi trắc nghiệm sẽ hiện tại đây sau khi tạo bài đọc.</div>
                </div>
                <div class="p-4 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    <button onclick="checkReadingQuiz()" id="btnCheckReading" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-md transition disabled:opacity-50 hidden">Nộp bài & Xem giải thích</button>
                </div>
            </div>
        </div>

        <!-- VIEW 5: WRITING -->
        <div id="viewWriting" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden bg-white">
            <div class="w-full md:w-1/3 bg-orange-50 border-r border-orange-100 flex flex-col p-4 overflow-y-auto">
                <div class="mb-4">
                    <h3 class="font-bold text-orange-800 mb-2 flex items-center"><i class="fas fa-lightbulb mr-2"></i> Thiết Lập Đề Viết</h3>
                    <div class="flex space-x-2 mb-2 text-xs">
                        <button onclick="toggleWritingMode('auto')" id="wBtnAuto" class="font-bold underline text-orange-700">Tạo Tự Động (AI)</button>
                        <span class="text-gray-400">|</span>
                        <button onclick="toggleWritingMode('manual')" id="wBtnManual" class="text-gray-500 hover:text-orange-700">Nhập Thủ Công</button>
                    </div>
                    
                    <div id="writeAutoUI" class="space-y-2">
                        <!-- Exam Type -->
                        <div class="flex space-x-2">
                             <select id="writeExamType" class="flex-1 p-2 border border-orange-200 rounded text-sm bg-white" onchange="updateWriteTasks()">
                                <option value="TOEIC">TOEIC Writing</option>
                                <option value="IELTS">IELTS Writing</option>
                            </select>
                             <select id="writeLevel" class="w-1/3 p-2 border border-orange-200 rounded text-sm bg-white">
                                <option value="easy">Dễ</option>
                                <option value="medium" selected>Vừa</option>
                                <option value="hard">Khó</option>
                            </select>
                        </div>
                        
                        <!-- Task Type (Dynamic) -->
                        <select id="writeTaskType" class="w-full p-2 border border-orange-200 rounded text-sm bg-white">
                            <!-- Populated by JS -->
                        </select>

                        <button onclick="generateWritingTopic()" id="btnGenWriteTopic" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded text-sm font-bold shadow-sm flex items-center justify-center">
                            <i class="fas fa-dice mr-1"></i> Tạo Đề Mới
                        </button>
                    </div>

                    <div id="writeManualUI" class="hidden">
                        <textarea id="writeManualInput" class="w-full p-2 border border-orange-200 rounded text-sm h-20" placeholder="Nhập đề bài..."></textarea>
                    </div>
                    
                    <div id="writingTopicDisplay" class="mt-4 p-3 bg-white border border-orange-200 rounded-lg text-sm font-medium text-gray-800 shadow-sm hidden"></div>
                </div>
                
                <div class="flex-1 mt-2 space-y-2">
                    <button onclick="getWritingOutline()" id="btnGetOutline" class="w-full bg-white border-2 border-orange-400 text-orange-700 hover:bg-orange-50 py-2 rounded-lg text-sm font-bold hidden flex items-center justify-center">
                        <i class="fas fa-sitemap mr-2"></i> Lập Dàn Ý & Tư Duy (AI)
                    </button>
                    <button onclick="getWritingHints()" id="btnGetHints" class="w-full border border-orange-300 text-orange-700 hover:bg-orange-100 py-2 rounded-lg text-sm font-bold hidden"><i class="fas fa-key mr-1"></i> Từ vựng Gợi ý</button>
                    <div id="writingHints" class="text-xs text-gray-700 space-y-2 overflow-y-auto hidden bg-white p-2 rounded border border-orange-100"></div>
                </div>
            </div>
            <div class="flex-1 flex flex-col p-4 md:p-6 bg-white overflow-y-auto">
                <h3 class="font-bold text-gray-800 mb-2">Bài viết của bạn</h3>
                <textarea id="writingInput" class="flex-1 w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-200 focus:outline-none resize-none font-medium text-gray-700 text-base leading-relaxed shadow-inner mb-3 min-h-[300px]" placeholder="Start writing here..."></textarea>
                
                <div class="flex space-x-2">
                    <button onclick="evaluateWriting()" id="btnEvalWriting" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-lg font-bold shadow-md transition flex items-center justify-center"><i class="fas fa-check-double mr-2"></i> Chấm điểm & Sửa lỗi</button>
                </div>

                <div id="writingFeedback" class="mt-4 hidden p-4 bg-gray-50 border border-gray-200 rounded-lg relative">
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <h4 class="font-bold text-gray-800">Đánh giá của AI:</h4>
                         <button onclick="downloadWritingWord()" class="text-blue-600 hover:text-blue-800 text-xs font-bold border border-blue-200 px-2 py-1 rounded bg-white"><i class="fas fa-file-word mr-1"></i> Xuất Word</button>
                    </div>
                    <div id="feedbackContent" class="text-sm text-gray-700 leading-relaxed mb-4"></div>
                    
                    <div class="bg-blue-50 p-3 rounded border border-blue-100 flex items-center justify-between">
                        <div class="flex items-center space-x-2 w-full">
                            <span class="text-xs font-bold text-blue-700">Lấy từ vựng hay:</span>
                            <select id="exportLevelWriting" class="text-xs p-1.5 border border-blue-200 rounded flex-1">
                                <option value="all">A1-C2 (Tất cả)</option>
                                <option value="b1">B1-C2 (Trung cấp+)</option>
                                <option value="b2" selected>B2-C2 (Nâng cao)</option>
                            </select>
                            <button onclick="exportDeepDrill('writingInput', 'exportLevelWriting')" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-blue-700 whitespace-nowrap"><i class="fas fa-file-export mr-1"></i> Xuất CSV</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 6: SPEAKING (RENAMED FROM PRONUNCIATION) -->
        <div id="viewPronun" class="hidden flex-1 flex flex-col bg-teal-50 overflow-hidden relative">
            <div class="bg-white p-4 border-b border-gray-200 flex flex-wrap gap-4 justify-between items-center shadow-sm z-10">
                <div class="flex items-center space-x-4 w-full md:w-auto">
                    <div class="flex items-center space-x-2 w-full">
                        <label class="text-xs font-bold text-gray-500 uppercase whitespace-nowrap">Chế độ:</label>
                        <select id="pronunType" onchange="toggleSpeakingMode()" class="flex-1 text-sm border border-gray-300 rounded p-1.5 bg-gray-50 focus:border-teal-500 focus:outline-none max-w-xs">
                            <optgroup label="Luyện Phát Âm (Drills)">
                                <option value="pairs">Cặp từ (Minimal Pairs)</option>
                                <option value="triplets">Nhóm 3 từ (Triplets)</option>
                                <option value="special">Từ khó/Đặc biệt</option>
                                <option value="ending_s">Phát âm đuôi -s/-es</option>
                                <option value="ending_ed">Phát âm đuôi -ed</option>
                            </optgroup>
                            <optgroup label="Luyện Speaking (Tests)">
                                <option value="toeic_speak">TOEIC Speaking (New Format)</option>
                                <option value="ielts_speak">IELTS Speaking (Interviewer)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <!-- Drill Controls -->
                <div id="drillControls" class="flex space-x-2">
                    <button onclick="generatePronunciationDrill()" id="btnGenPronun" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Tạo bài tập (AI)
                    </button>
                    <button onclick="exportPronunciation()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition flex items-center">
                        <i class="fas fa-file-export mr-2"></i> Xuất CSV
                    </button>
                </div>

                <!-- Test Controls -->
                <div id="testControls" class="hidden flex space-x-2 flex-1 md:justify-end relative">
                    <input type="text" id="speakTopic" placeholder="Chủ đề (VD: Hobbies)..." class="p-2 border border-gray-300 rounded text-sm w-32 md:w-48">
                    <button onclick="suggestTrendingTopics('speaking')" class="text-pink-500 px-2 hover:bg-pink-50 rounded" title="Gợi ý Topic"><i class="fas fa-magic"></i></button>
                    <div id="speakTrendSuggestions" class="absolute top-10 right-20 z-50 bg-white border border-gray-200 shadow-xl p-2 rounded w-64 hidden flex flex-col gap-1"></div>

                    <button onclick="generateSpeakingTest()" id="btnGenSpeakTest" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition flex items-center whitespace-nowrap">
                        <i class="fas fa-play-circle mr-2"></i> Bắt đầu thi
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div id="pronunContent" class="flex-1 overflow-y-auto p-4 md:p-6">
                <!-- Empty State -->
                <div id="pronunEmpty" class="h-full flex flex-col items-center justify-center text-gray-400">
                    <div class="w-24 h-24 bg-teal-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-microphone-alt text-4xl text-teal-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Luyện Speaking & Phát Âm</h3>
                    <p class="mb-6 text-center max-w-sm">Chọn chế độ Luyện tập (Drills) hoặc Thi thử (Tests) để bắt đầu.</p>
                </div>
                
                <!-- Drill Grid Container -->
                <div id="pronunGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Test Interface Container -->
                <div id="speakingTestInterface" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden flex flex-col h-full">
                    <div id="speakTestHeader" class="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                        <h3 class="font-bold text-gray-800 flex items-center"><i class="fas fa-user-clock mr-2 text-purple-600"></i><span id="speakTestTypeLabel">IELTS SPEAKING</span></h3>
                        <div class="flex space-x-2">
                             <span class="text-xs font-bold px-2 py-1 bg-purple-100 text-purple-800 rounded flex items-center"><i class="fas fa-stopwatch mr-1"></i> Exam Mode</span>
                        </div>
                    </div>
                    
                    <div id="speakQuestionArea" class="flex-1 overflow-y-auto p-6 space-y-8 bg-gray-50">
                        <!-- Questions injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 7: GRAMMAR -->
        <div id="viewGrammar" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden bg-red-50 relative">
            
            <!-- Sidebar: Grammar Tree -->
            <div class="w-full md:w-80 lg:w-96 bg-white border-r border-red-100 flex flex-col flex-shrink-0 h-full">
                <div class="p-4 border-b border-red-100 flex justify-between items-center bg-red-50">
                    <h3 class="font-bold text-red-900"><i class="fas fa-network-wired mr-2"></i>Hệ thống Chủ điểm</h3>
                    <span class="text-xs text-red-500 font-bold bg-white px-2 py-1 rounded-full shadow-sm border border-red-100">Lý thuyết & Bài tập</span>
                </div>
                <div id="grammarTreeContainer" class="flex-1 overflow-y-auto p-3 space-y-2 text-sm">
                    <!-- Tree content injected by JS -->
                </div>
                
                <!-- NEW LOCATION: Vocab Enrichment Tool (Fixed in Sidebar) -->
                <div class="p-3 border-t border-red-100 bg-yellow-50">
                    <div class="flex justify-between items-center mb-2 pb-1 border-b border-yellow-200">
                         <h4 class="font-bold text-red-800 text-xs"><i class="fas fa-wand-magic-sparkles mr-1 text-yellow-600"></i>Tạo CSV Từ vựng</h4>
                         <i class="fas fa-info-circle text-gray-400 cursor-help text-[10px]" title="Upload danh sách từ (1 cột) -> AI thêm nghĩa & IPA -> Tải về CSV 4 cột để dùng."></i>
                    </div>
                    <div class="space-y-2">
                        <div class="relative">
                             <input type="file" id="vocabToolInput" accept=".csv,.txt" class="hidden" onchange="handleVocabToolUpload(event)">
                            <label for="vocabToolInput" class="cursor-pointer block w-full text-center bg-white border border-dashed border-gray-300 rounded py-1.5 text-[10px] text-gray-600 hover:bg-gray-50 transition">
                                <span id="vocabToolFileName">Chọn file (txt/csv)</span>
                            </label>
                        </div>
                        <button onclick="generateEnrichedCSV()" id="btnVocabToolAction" class="w-full bg-red-600 hover:bg-red-700 text-white py-1.5 rounded font-bold shadow-sm disabled:opacity-50 disabled:cursor-not-allowed text-[10px]">
                            Xử lý & Tải về
                        </button>
                    </div>
                </div>

                <!-- Import Vocab Section -->
                <div class="p-3 border-t border-red-100 bg-red-50">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Tích hợp Từ vựng (CSV):</label>
                        <span id="grammarVocabStatus" class="text-[10px] text-gray-400 font-mono">Chưa tải</span>
                    </div>
                    <div class="relative group">
                        <input type="file" id="grammarVocabInput" accept=".csv" class="hidden" onchange="handleGrammarVocabUpload(event)">
                        <label for="grammarVocabInput" class="cursor-pointer bg-white border border-red-200 text-red-700 hover:bg-red-50 w-full py-1.5 rounded text-xs font-bold flex items-center justify-center transition shadow-sm">
                            <i class="fas fa-file-import mr-2"></i> Tải danh sách từ
                        </label>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1 italic">AI sẽ tạo câu hỏi chứa từ vựng bạn tải lên.</p>
                </div>

                <div class="p-4 border-t border-red-100 bg-white">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Độ khó:</label>
                    <select id="grammarLevel" class="w-full p-2 border border-gray-300 rounded mb-2 text-sm">
                        <option value="easy">Dễ (Cơ bản)</option>
                        <option value="medium" selected>Trung bình (Khá)</option>
                        <option value="hard">Khó (Nâng cao)</option>
                    </select>
                    <button onclick="generateGrammarQuiz()" id="btnGenGrammar" class="w-full bg-red-800 hover:bg-red-900 text-white py-2 rounded font-bold shadow-md transition text-sm">
                        <i class="fas fa-bolt mr-2 text-yellow-300"></i> Tạo Bài Tập (20 câu)
                    </button>
                </div>
            </div>
            
            <!-- Main Content: Quiz Area -->
            <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 relative">
                <!-- Placeholder -->
                <div id="grammarEmptyState" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center">
                    <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-4 border-4 border-white shadow-sm">
                        <i class="fas fa-book-open text-4xl text-red-700"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-700 mb-2">Luyện Tập Ngữ Pháp Chuyên Sâu</h2>
                    <p class="text-gray-500 max-w-md text-sm mb-4">Chọn chủ điểm bên trái và nhấn "Tạo Bài Tập". Hệ thống sẽ kết hợp ngữ pháp với từ vựng của bạn.</p>
                </div>

                <!-- Quiz List Container -->
                <div id="grammarQuizContent" class="hidden flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-20">
                    <!-- Questions injected here -->
                </div>

                <!-- Result Action Bar (Fixed at bottom) -->
                <div id="grammarActionBar" class="hidden p-4 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 flex justify-between items-center">
                    <div class="text-sm font-bold text-gray-700">
                        Kết quả: <span id="grammarScore" class="text-red-600 text-lg">--/--</span>
                    </div>
                    <div class="flex space-x-2">
                         <button onclick="checkGrammarAnswers()" id="btnCheckGrammar" class="bg-red-700 hover:bg-red-800 text-white px-6 py-2 rounded font-bold shadow transition">
                            Nộp Bài
                        </button>
                        <button onclick="handleImproveWeaknesses()" id="btnImproveGrammar" class="hidden bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded font-bold shadow transition">
                            <i class="fas fa-tools mr-1"></i> Cải thiện phần sai
                        </button>
                         <button onclick="resetGrammarQuiz()" id="btnResetGrammar" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded font-bold shadow transition">
                            <i class="fas fa-redo mr-1"></i> Làm mới
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 8: VOCABULARY -->
        <div id="viewVocab" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden bg-cyan-50 relative">
            
            <!-- Sidebar: Config -->
            <div class="w-full md:w-80 lg:w-96 bg-white border-r border-cyan-100 flex flex-col flex-shrink-0 h-full">
                <div class="p-4 border-b border-cyan-100 bg-cyan-50">
                    <h3 class="font-bold text-cyan-900 mb-2"><i class="fas fa-shapes mr-2"></i>Phòng Luyện Từ Vựng</h3>
                    
                    <!-- TOEIC / IELTS Switch -->
                    <div class="flex bg-white rounded p-1 border border-cyan-200 mb-4">
                        <button onclick="switchVocabType('TOEIC')" id="btnVocabToeic" class="flex-1 py-1.5 rounded text-xs font-bold bg-cyan-600 text-white shadow transition">TOEIC (Business)</button>
                        <button onclick="switchVocabType('IELTS')" id="btnVocabIelts" class="flex-1 py-1.5 rounded text-xs font-bold text-gray-500 hover:bg-gray-50 transition">IELTS (Academic)</button>
                    </div>

                    <!-- Topic Dropdown -->
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chủ đề:</label>
                    <select id="vocabTopicSelect" class="w-full p-2 border border-gray-300 rounded mb-3 text-sm bg-white focus:outline-none focus:border-cyan-500">
                        <!-- Populated via JS -->
                    </select>

                    <!-- Level -->
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hạng từ vựng:</label>
                    <select id="vocabLevel" class="w-full p-2 border border-gray-300 rounded mb-3 text-sm bg-white">
                        <option value="A2">A2 (Sơ cấp)</option>
                        <option value="B1">B1 (Trung cấp)</option>
                        <option value="B2">B2 (Trung cao cấp)</option>
                        <option value="C1">C1 (Cao cấp)</option>
                        <option value="C2">C2 (Thành thạo)</option>
                    </select>

                    <!-- Import Vocab Section for Vocab Quiz -->
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Tích hợp Từ vựng (CSV):</label>
                            <span id="vocabVocabStatus" class="text-[10px] text-gray-400 font-mono">Chưa tải</span>
                        </div>
                        <div class="relative group">
                            <input type="file" id="vocabVocabInput" accept=".csv" class="hidden" onchange="handleVocabVocabUpload(event)">
                            <label for="vocabVocabInput" class="cursor-pointer bg-white border border-cyan-200 text-cyan-700 hover:bg-cyan-50 w-full py-1.5 rounded text-xs font-bold flex items-center justify-center transition shadow-sm">
                                <i class="fas fa-file-import mr-2"></i> Tải danh sách từ
                            </label>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-1 italic">AI sẽ ưu tiên dùng từ vựng trong file CSV của bạn.</p>
                    </div>

                    <button onclick="generateVocabQuiz()" id="btnGenVocab" class="w-full bg-cyan-700 hover:bg-cyan-800 text-white py-2.5 rounded font-bold shadow-md transition text-sm flex items-center justify-center">
                        <i class="fas fa-bolt mr-2 text-yellow-300"></i> Tạo Đề (15 Câu)
                    </button>
                </div>

                <div class="flex-1 bg-white p-4">
                    <div class="text-xs text-gray-500 italic mb-4">
                        <i class="fas fa-info-circle mr-1"></i> Tính năng:
                        <ul class="list-disc ml-4 mt-1 space-y-1">
                            <li>15 câu hỏi trắc nghiệm</li>
                            <li>Gợi ý: Cụm từ cố định + Dịch câu hỏi</li>
                            <li>Hỗ trợ xuất Excel/CSV</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content: Quiz -->
            <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 relative">
                <!-- Placeholder -->
                <div id="vocabEmptyState" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center">
                    <div class="w-24 h-24 bg-cyan-100 rounded-full flex items-center justify-center mb-4 border-4 border-white shadow-sm">
                        <i class="fas fa-cube text-4xl text-cyan-600"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-700 mb-2">Chọn Chủ Đề Để Bắt Đầu</h2>
                    <p class="text-gray-500 max-w-md text-sm mb-4">Hệ thống sẽ tạo 15 câu hỏi trắc nghiệm từ vựng theo chuẩn TOEIC hoặc IELTS.</p>
                </div>

                <!-- Quiz List -->
                <div id="vocabQuizContent" class="hidden flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-20"></div>

                <!-- Action Bar -->
                <div id="vocabActionBar" class="hidden p-4 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 flex justify-between items-center">
                    <div class="text-sm font-bold text-gray-700">
                        Kết quả: <span id="vocabScore" class="text-cyan-600 text-lg">--/15</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="exportVocabQuiz()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold shadow transition text-sm">
                            <i class="fas fa-file-excel mr-1"></i> Xuất CSV
                        </button>
                        <button onclick="checkVocabAnswers()" id="btnCheckVocab" class="bg-cyan-700 hover:bg-cyan-800 text-white px-6 py-2 rounded font-bold shadow transition">
                            Nộp Bài
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden Audio Element -->
    <audio id="mainAudio" ontimeupdate="updateProgress()" onloadedmetadata="audioLoaded()" onended="audioEnded()"></audio>

    <script>
        const defaultApiKey = ""; 
        const FILE_SIZE_LIMIT = 9.5 * 1024 * 1024;
        
        // --- NEW ADMIN KEY LOGIC ---
        const ADMIN_KEYS = [
            "AIzaSyDW2jzbCXaql1D8l9f7vmHyN6JknN5yImo",
            "AIzaSyDS7CIwEa4qWnQ6778IwMwWWp0fD-QRmNo",
            "AIzaSyDJ66vf6eyfOnwbGeQIRi4Hk1yUy0axvmA",
            "AIzaSyBdzSceL2owM51O1ECfp43CUnxZrav5O3k",
            "AIzaSyAFNplq1n2Q4rUmfRRzXZymJwiWzoBW3B8"
        ];
        let adminKeyIndex = 0;
        let adminKeyStatus = new Array(ADMIN_KEYS.length).fill('active'); // 'active', 'exhausted'

        // --- GRAMMAR TREE DATA ---
        const GRAMMAR_TREE = [
            {
                id: 'p1', title: 'Phần 1: Từ loại (Parts of Speech)', color: 'text-green-800', bg: 'bg-green-100',
                children: [
                    { id: 'n', title: 'Danh từ (Nouns)', desc: 'Countable, Uncountable, Possessive...' },
                    { id: 'pro', title: 'Đại từ (Pronouns)', desc: 'Personal, Possessive, Reflexive...' },
                    { id: 'v', title: 'Động từ (Verbs)', desc: 'Action verbs, Linking verbs, Modal verbs...' },
                    { id: 'adj', title: 'Tính từ (Adjectives)', desc: 'Order (OSASCOMP), Endings...' },
                    { id: 'adv', title: 'Trạng từ (Adverbs)', desc: 'Frequency, Manner, Time, Place...' },
                    { id: 'prep', title: 'Giới từ (Prepositions)', desc: 'In, On, At, By, With...' },
                    { id: 'art', title: 'Mạo từ (Articles)', desc: 'A, An, The, Zero article' },
                    { id: 'conj', title: 'Liên từ (Conjunctions)', desc: 'Coordinating, Subordinating...' }
                ]
            },
            {
                id: 'p2', title: 'Phần 2: Các thì (Tenses)', color: 'text-yellow-800', bg: 'bg-yellow-100',
                children: [
                    { id: 't_pres', title: 'Nhóm Hiện tại (Present)', desc: 'Simple, Continuous, Perfect, Perfect Cont.' },
                    { id: 't_past', title: 'Nhóm Quá khứ (Past)', desc: 'Simple, Continuous, Perfect, Perfect Cont.' },
                    { id: 't_fut', title: 'Nhóm Tương lai (Future)', desc: 'Simple, Near, Continuous, Perfect' }
                ]
            },
            {
                id: 'p3', title: 'Phần 3: Cấu trúc câu (Sentence Structure)', color: 'text-blue-800', bg: 'bg-blue-100',
                children: [
                    { id: 'sent', title: 'Thành phần câu & Hòa hợp S-V', desc: 'Subject-Verb Agreement' },
                    { id: 'pass', title: 'Câu Bị động (Passive Voice)', desc: 'Be + V3/ed, Special cases' },
                    { id: 'rep', title: 'Câu Tường thuật (Reported Speech)', desc: 'Direct to Indirect speech' },
                    { id: 'cond', title: 'Câu Điều kiện (Conditional)', desc: 'Types 0, 1, 2, 3, Mixed' },
                    { id: 'rel', title: 'Mệnh đề quan hệ (Relative Clauses)', desc: 'Defining & Non-defining' },
                    { id: 'comp', title: 'So sánh (Comparisons)', desc: 'Equal, Comparative, Superlative' }
                ]
            },
            {
                id: 'p4', title: 'Phần 4: Chuyên đề Nâng cao (Advanced)', color: 'text-pink-800', bg: 'bg-pink-100',
                children: [
                    { id: 'ger', title: 'V-ing & To V', desc: 'Gerunds & Infinitives' },
                    { id: 'inv', title: 'Đảo ngữ (Inversion)', desc: 'Negative adverbs, Conditionals' },
                    { id: 'subj', title: 'Câu giả định (Subjunctive)', desc: 'Wish, Would rather, It\'s time...' },
                    { id: 'phras', title: 'Cụm động từ (Phrasal Verbs)', desc: 'Two/Three-part verbs' },
                    { id: 'idiom', title: 'Thành ngữ & Collocations', desc: 'Fixed expressions' }
                ]
            },
            {
                id: 'p5', title: 'Phần 5: Động từ Bất quy tắc (Irregular Verbs)', color: 'text-orange-800', bg: 'bg-orange-100',
                children: [
                    { id: 'irr_all', title: '360 Động từ bất quy tắc', desc: 'Luyện tập V1, V2, V3 & Nghĩa' },
                    { id: 'irr_common', title: '100 Động từ phổ biến', desc: 'Các từ hay gặp nhất' },
                    { id: 'irr_groups', title: 'Nhóm theo quy tắc', desc: 'AAA, ABA, ABB...' }
                ]
            }
        ];

        // --- VOCABULARY TOPIC DATA ---
        const VOCAB_TOPICS = {
            "TOEIC": [
                { id: "v_job", name: "Công việc & Sự nghiệp (Tuyển dụng, Hợp đồng, Lương...)" },
                { id: "v_finance", name: "Kinh tế & Tài chính (Ngân hàng, Thuế, Kế toán...)" },
                { id: "v_office_tech", name: "Công nghệ Văn phòng (Thiết bị, Phần mềm, Bảo trì...)" },
                { id: "v_infrastructure", name: "Cơ sở vật chất (Xây dựng, Điện nước, Văn phòng...)" },
                { id: "v_training", name: "Đào tạo & Kỹ năng (Hội thảo, Chứng chỉ...)" },
                { id: "v_insurance", name: "Sức khỏe & An toàn (Bảo hiểm, Nghỉ phép...)" },
                { id: "v_service", name: "Dịch vụ & Du lịch (Đặt phòng, Khiếu nại, Thực đơn...)" }
            ],
            "IELTS": [
                { id: "v_labor", name: "Thị trường Lao động (Thất nghiệp, Tự động hóa...)" },
                { id: "v_global_eco", name: "Kinh tế Toàn cầu (Toàn cầu hóa, Thương mại...)" },
                { id: "v_future_tech", name: "Công nghệ Tương lai (AI, Không gian, Gen...)" },
                { id: "v_environment", name: "Môi trường & Khí hậu (Biến đổi, Năng lượng...)" },
                { id: "v_education", name: "Hệ thống Giáo dục (Đại học, Học phí...)" },
                { id: "v_public_health", name: "Y tế Cộng đồng (Dịch bệnh, Dinh dưỡng...)" },
                { id: "v_culture", name: "Văn hóa & Xã hội (Di sản, Du lịch đại chúng...)" }
            ]
        };
        
        // Reading Parts
        const READING_PARTS = {
            "TOEIC": [
                { id: "part5", name: "Part 5: Incomplete Sentences" },
                { id: "part6", name: "Part 6: Text Completion" },
                { id: "part7", name: "Part 7: Reading Comprehension" }
            ],
            "IELTS": [
                { id: "passage1", name: "Passage 1 (General/Factual)" },
                { id: "passage2", name: "Passage 2 (Discursive/Workplace)" },
                { id: "passage3", name: "Passage 3 (Analytical/Academic)" }
            ]
        };
        
        let grammarQuizData = [];
        let vocabQuizData = []; // Store Vocab Questions
        let failedGrammarTopics = new Set(); 
        let grammarVocabList = []; 
        let vocabVocabList = []; // NEW: Store Vocab Module Custom List
        let rawVocabToolData = ""; 
        let currentVocabType = "TOEIC";
        let currentReadingData = null; // Store Reading Data (Passage + Qs)
        let speakingTestData = null; // Store Speaking Data
        let audioGenSettings = { mode: 'topic', exam: 'TOEIC', part: '1' }; // Store audio gen mode

        // --- APP INIT ---
        function initApp() {
            renderGrammarTree();
            renderVocabTopics(); // Init Vocab UI
            updateApiKeyUI();
            updateWriteTasks(); // Init Write Tasks
            updateReadParts(); // Init Reading Parts
        }

        // --- API KEY UI LOGIC ---
        function getApiKey() {
            const userKey = localStorage.getItem("USER_GEMINI_API_KEY");
            if (userKey === "ADMIN_MODE") {
                return ADMIN_KEYS[adminKeyIndex];
            }
            return userKey || defaultApiKey;
        }

        function toggleApiKeyBox() {
            const box = document.getElementById('apiKeyInputBox');
            box.classList.toggle('hidden');
            if(!box.classList.contains('hidden')) {
                updateApiKeyUI();
            }
        }

        function updateApiKeyUI() {
            const isManual = localStorage.getItem("USER_GEMINI_API_KEY") !== "ADMIN_MODE";
            const manualView = document.getElementById('manualKeyView');
            const adminView = document.getElementById('adminKeyView');
            const userInp = document.getElementById('userApiKeyInput');
            const dot = document.getElementById('adminModeDot');

            if (isManual) {
                if(manualView) manualView.classList.remove('hidden');
                if(adminView) adminView.classList.add('hidden');
                userInp.value = localStorage.getItem("USER_GEMINI_API_KEY") || "";
                if(dot) dot.classList.add('hidden');
            } else {
                if(manualView) manualView.classList.add('hidden');
                if(adminView) adminView.classList.remove('hidden');
                renderAdminIndicators();
                if(dot) dot.classList.remove('hidden');
            }
        }

        function saveUserApiKey() {
            const key = document.getElementById('userApiKeyInput').value.trim();
            if (key === "091440") {
                // Activate Admin Mode
                localStorage.setItem("USER_GEMINI_API_KEY", "ADMIN_MODE");
                showToast("Đã kích hoạt chế độ ADMIN (Auto Key)!");
                // Reset admin state
                adminKeyIndex = 0;
                adminKeyStatus.fill('active');
                updateApiKeyUI();
            } else if(key) {
                localStorage.setItem("USER_GEMINI_API_KEY", key);
                showToast("Đã lưu API Key!");
                toggleApiKeyBox();
            } else {
                localStorage.removeItem("USER_GEMINI_API_KEY");
                showToast("Đã xóa API Key cá nhân!");
            }
        }

        function exitAdminMode() {
            localStorage.removeItem("USER_GEMINI_API_KEY");
            showToast("Đã tắt chế độ Admin.");
            updateApiKeyUI();
        }

        function renderAdminIndicators() {
            const container = document.getElementById('adminKeyIndicators');
            if(!container) return;
            container.innerHTML = '';
            adminKeyStatus.forEach((status, i) => {
                const dot = document.createElement('div');
                dot.className = `key-dot ${status === 'active' && i === adminKeyIndex ? 'key-active' : (status === 'exhausted' ? 'key-dead' : 'key-waiting')}`;
                if (status === 'active' && i === adminKeyIndex) dot.style.backgroundColor = '#10b981'; // Green for current
                else if (status === 'exhausted') dot.style.backgroundColor = '#ef4444'; // Red for dead
                else dot.style.backgroundColor = '#d1d5db'; // Grey for others
                container.appendChild(dot);
            });
            document.getElementById('currentKeyInfo').innerText = `Using Key #${adminKeyIndex + 1}...`;
        }

        function getSafeText(data) {
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                throw new Error("AI không trả về nội dung (Có thể bị chặn Safety Filter hoặc hết Quota).");
            }
            return data.candidates[0].content.parts[0].text;
        }

        async function callGeminiAPI(modelName, payload) {
            let attempts = 0;
            const isUserAdmin = localStorage.getItem("USER_GEMINI_API_KEY") === "ADMIN_MODE";
            const maxAttempts = isUserAdmin ? ADMIN_KEYS.length + 1 : 1;

            while (attempts < maxAttempts) {
                const key = getApiKey();
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
                
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await res.json();
                    if (data.error) {
                        const code = data.error.code;
                        const msg = data.error.message.toLowerCase();
                        if (isUserAdmin && (code === 429 || msg.includes('quota') || msg.includes('limit') || code === 403)) {
                            console.warn(`Key #${adminKeyIndex+1} exhausted. Rotating...`);
                            markKeyExhausted(adminKeyIndex);
                            rotateAdminKey();
                            attempts++;
                            continue; 
                        }
                        throw new Error(data.error.message);
                    }
                    return data; 
                } catch (e) {
                    if (isUserAdmin && attempts < maxAttempts - 1) {
                        if (e.message.includes('quota') || e.message.includes('429')) {
                            continue;
                        }
                    }
                    throw e;
                }
            }
            throw new Error("Tất cả Admin Keys đã hết lượt hoặc lỗi mạng!");
        }

        function rotateAdminKey() {
            let start = adminKeyIndex;
            let next = (adminKeyIndex + 1) % ADMIN_KEYS.length;
            while(next !== start) {
                if (adminKeyStatus[next] !== 'exhausted') {
                    adminKeyIndex = next;
                    renderAdminIndicators();
                    return;
                }
                next = (next + 1) % ADMIN_KEYS.length;
            }
            alert("⚠️ CẢNH BÁO: Tất cả Admin Keys đã bị đánh dấu là hết hạn!");
        }

        function markKeyExhausted(idx) {
            adminKeyStatus[idx] = 'exhausted';
            renderAdminIndicators();
        }

        // --- STATE ---
        let isPlaying = false;
        let isLooping = false;
        let audioDuration = 0;
        let hasTranscript = false;
        let currentFile = null;
        let currentAudioBase64 = null;
        let currentMimeType = "audio/mp3";
        let quizData = [];
        let readingQuizData = []; 
        let segmentEnd = null; 
        let writingMode = 'auto';
        let transcriptData = []; 
        let pronunciationData = [];
        let pronunciationHistory = [];

        // --- DEEP DRILL STATE ---
        let deepSessionData = [];
        let deepCurrentGroup = 0;
        let deepCurrentChallenge = 0;
        let deepScore = { correct: 0, wrong: 0 };
        let deepIsRetrying = false;
        let deepFileName = "";
        let recognition = null;
        let isRecording = false;

        // --- DOM ELEMENTS ---
        const audio = document.getElementById('mainAudio');
        const playBtn = document.getElementById('playBtn');
        const progressBar = document.getElementById('progressBar');
        const hintSegment = document.getElementById('hintSegment');
        const seekSlider = document.getElementById('seekSlider');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const downloadAudioBtn = document.getElementById('downloadAudioBtn');
        const toastEl = document.getElementById('toast');
        const loader = document.getElementById('fullScreenLoader');
        const loaderText = document.getElementById('loaderText');
        const audioGenModal = document.getElementById('audioGenModal');
        const setupModal = document.getElementById('setupModal');
        const targetText = document.getElementById('targetText');
        const userTyping = document.getElementById('userTyping');
        const diffOutput = document.getElementById('diffOutput');
        const quizContent = document.getElementById('quizContent');
        const readingDisplay = document.getElementById('readingDisplay');
        const readingQuizContainer = document.getElementById('readingQuizContainer');
        const readingPlaceholder = document.getElementById('readingPlaceholder');
        const transcriptContent = document.getElementById('transcriptContent');
        const transcriptPlaceholder = document.getElementById('transcriptPlaceholder');

        // --- COMMON UTILS ---
        function showToast(msg) {
            toastEl.innerText = msg; toastEl.classList.remove('opacity-0');
            setTimeout(() => toastEl.classList.add('opacity-0'), 3000);
        }
        function openSetupModal() { setupModal.classList.remove('hidden'); }
        function closeSetupModal() { setupModal.classList.add('hidden'); }
        function openAudioGenModal() { audioGenModal.classList.remove('hidden'); }
        function closeAudioGenModal() { audioGenModal.classList.add('hidden'); }
        function showLoader(text) { loaderText.innerText = text; loader.classList.remove('hidden'); }
        function hideLoader() { loader.classList.add('hidden'); }

        // --- TREND SUGGESTION ---
        async function suggestTrendingTopics(type) {
            // New logic to handle speaking separately
            let container, input, difficulty;

            if (type === 'speaking') {
                container = document.getElementById('speakTrendSuggestions');
                input = document.getElementById('speakTopic');
                difficulty = 'medium'; // Default difficulty for speaking suggestions
            } else if (type === 'audio') {
                container = document.getElementById('audioTrendSuggestions');
                input = document.getElementById('genTopic');
                difficulty = document.getElementById('genDifficulty').value;
            } else if (type === 'audio_exam') {
                container = document.getElementById('audioExamSuggestions');
                input = document.getElementById('examTopic');
                difficulty = 'medium'; // Default for exam
            } else {
                container = document.getElementById('readTrendSuggestions');
                input = document.getElementById('readTopic');
                difficulty = document.getElementById('readLevel').value;
            }

            container.innerHTML = '<span class="text-xs text-gray-400 p-2">Đang tìm trend...</span>'; 
            container.classList.remove('hidden');
            
            // Adjusted prompt for exam suggestion
            let promptType = type === 'audio' || type === 'speaking' ? 'speaking/listening' : 'reading';
            if(type === 'audio_exam') promptType = 'IELTS/TOEIC listening test';

            const prompt = `Generate 3 trending ${promptType} topics for ${difficulty} level. Output ONLY JSON array: ["Topic 1", "Topic 2", "Topic 3"]`;
            
            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json/g, '').replace(/```/g, '').trim();
                const topics = JSON.parse(text);
                
                container.innerHTML = '';
                topics.forEach(t => {
                    const chip = document.createElement('div');
                    // Style specific for speaking dropdown vs others
                    if (type === 'speaking') {
                        chip.className = "cursor-pointer p-2 hover:bg-purple-50 text-sm text-gray-700 border-b border-gray-100 last:border-0";
                    } else if (type === 'audio_exam') {
                         chip.className = `trend-chip px-3 py-1 bg-pink-100 text-pink-700 rounded-full text-xs font-bold border border-pink-200 cursor-pointer`;
                    } else {
                        chip.className = `trend-chip px-3 py-1 bg-${type === 'audio' ? 'pink' : 'green'}-100 text-${type === 'audio' ? 'pink' : 'green'}-700 rounded-full text-xs font-bold border border-${type === 'audio' ? 'pink' : 'green'}-200 cursor-pointer`;
                    }
                    
                    chip.innerText = t; 
                    chip.onclick = () => { 
                        input.value = t; 
                        container.classList.add('hidden'); 
                    };
                    container.appendChild(chip);
                });
                
                // Hide on click outside
                if (type === 'speaking') {
                    const closeFn = (e) => {
                         if (!container.contains(e.target) && e.target !== input) {
                            container.classList.add('hidden');
                            document.removeEventListener('click', closeFn);
                         }
                    };
                    setTimeout(() => document.addEventListener('click', closeFn), 100);
                }

            } catch(e) { container.innerHTML = '<span class="text-xs text-red-400 p-2">Lỗi. Kiểm tra API Key.</span>'; }
        }

        // --- READING MODULE (UPDATED) ---
        function updateReadParts() {
            const exam = document.getElementById('readExamType').value;
            const select = document.getElementById('readExamPart');
            select.innerHTML = '';
            
            READING_PARTS[exam].forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.innerText = p.name;
                select.appendChild(opt);
            });
        }
        
        async function generateReadingTask() {
            const exam = document.getElementById('readExamType').value;
            const part = document.getElementById('readExamPart').value;
            const topic = document.getElementById('readTopic').value || "General Business/Academic";
            const level = document.getElementById('readLevel').value;

            document.getElementById('readingModal').classList.add('hidden');
            showLoader("AI đang viết bài đọc & soạn câu hỏi...");
            
            // Construct Prompt
            const prompt = `
            Act as an expert ${exam} exam writer. Create a ${part} reading task.
            Topic: ${topic}.
            Level: ${level}.
            
            Task Requirements:
            1. Generate a reading passage appropriate for ${exam} ${part} (approx 200-400 words).
            2. Create 3-5 multiple choice questions (A, B, C, D).
            3. For each question, provide a detailed "Thinking Process" guide.
            
            Output STRICT JSON format:
            {
                "title": "Passage Title",
                "passage": "Full reading text here...",
                "questions": [
                    {
                        "id": 1,
                        "question": "Question text...",
                        "options": ["Option A", "Option B", "Option C", "Option D"],
                        "correct_index": 0, (0 for A, 1 for B, etc.)
                        "guide": {
                            "skim_loc": "Paragraph 1, Line 3...", (Where to find info)
                            "keywords": "keyword1, keyword2...", (Words to scan for)
                            "nudge": "Notice the synonym for '...' used in the text.", (Hint without giving answer)
                            "explanation": "Full explanation why this option is correct and others are wrong."
                        }
                    }
                ]
            }
            `;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let txt = getSafeText(data).replace(/```json/g, '').replace(/```/g, '').trim();
                
                try {
                    currentReadingData = JSON.parse(txt);
                } catch(e) {
                     // Fallback simple parsing if needed, but usually strict json works
                     const firstBracket = txt.indexOf('{');
                     const lastBracket = txt.lastIndexOf('}');
                     if(firstBracket !== -1 && lastBracket !== -1) {
                         currentReadingData = JSON.parse(txt.substring(firstBracket, lastBracket + 1));
                     } else throw e;
                }
                
                renderReadingTask();
                showToast("Đã tạo đề Reading thành công!");

            } catch(e) {
                alert("Lỗi AI: " + e.message);
            } finally {
                hideLoader();
            }
        }

        function renderReadingTask() {
            if(!currentReadingData) return;
            
            // Switch view
            switchTab('reading');
            
            // Render Passage
            document.getElementById('readingPlaceholder').classList.add('hidden');
            const display = document.getElementById('readingDisplay');
            display.classList.remove('hidden');
            display.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">${currentReadingData.title || 'Reading Passage'}</h2>
                <div class="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-100 shadow-inner">
                    ${currentReadingData.passage.replace(/\n/g, '<br><br>')}
                </div>
            `;
            
            // Render Questions
            const qContainer = document.getElementById('readingQuizContainer');
            qContainer.innerHTML = '';
            
            currentReadingData.questions.forEach((q, idx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "p-3 bg-gray-50 rounded border border-gray-200 mb-4";
                
                let opts = '';
                q.options.forEach((opt, oIdx) => {
                    opts += `
                        <label class="flex items-start space-x-2 mt-2 cursor-pointer p-2 hover:bg-white rounded transition rq-option-label" id="rq_lbl_${idx}_${oIdx}">
                            <input type="radio" name="rq_${idx}" value="${oIdx}" class="mt-1 form-radio text-green-600">
                            <span class="text-sm text-gray-700">${opt}</span>
                        </label>
                    `;
                });

                qDiv.innerHTML = `
                    <div class="font-bold text-sm text-gray-800 mb-2">Q${idx+1}: ${q.question}</div>
                    <div class="flex flex-col">${opts}</div>
                    <div id="rq_res_${idx}" class="mt-2 text-xs font-bold"></div>
                    
                    <div class="mt-2 flex justify-end">
                        <button onclick="toggleReadingHint(${idx})" class="text-xs text-orange-600 hover:text-orange-800 font-bold flex items-center">
                            <i class="far fa-lightbulb mr-1"></i> Gợi ý (Mớm ý)
                        </button>
                    </div>
                    <div id="rq_hint_${idx}" class="reading-hint-box hidden">
                        <div><b><i class="fas fa-search mr-1"></i>Vị trí:</b> ${q.guide.skim_loc}</div>
                        <div><b><i class="fas fa-key mr-1"></i>Keywords:</b> ${q.guide.keywords}</div>
                        <div class="italic text-gray-600 mt-1">"${q.guide.nudge}"</div>
                    </div>
                    <div id="rq_exp_${idx}" class="hidden mt-2 p-2 bg-green-50 text-green-800 text-xs rounded border border-green-100">
                        <b><i class="fas fa-check-circle mr-1"></i>Giải thích chi tiết:</b><br>
                        ${q.guide.explanation}
                    </div>
                `;
                qContainer.appendChild(qDiv);
            });
            
            // Show check button and action bar
            document.getElementById('btnCheckReading').classList.remove('hidden');
            document.getElementById('readingActionBar').classList.remove('hidden');
            document.getElementById('readingActionBar').classList.add('flex');
            document.getElementById('readingExportUI').classList.remove('hidden');
        }
        
        function toggleReadingHint(idx) {
            const h = document.getElementById(`rq_hint_${idx}`);
            if(h.style.display === 'block') h.style.display = 'none';
            else h.style.display = 'block';
        }

        function checkReadingQuiz() {
            if(!currentReadingData) return;
            let correct = 0;
            
            currentReadingData.questions.forEach((q, idx) => {
                const selected = document.querySelector(`input[name="rq_${idx}"]:checked`);
                const resEl = document.getElementById(`rq_res_${idx}`);
                const expEl = document.getElementById(`rq_exp_${idx}`);
                
                // Disable inputs
                document.querySelectorAll(`input[name="rq_${idx}"]`).forEach(i => i.disabled = true);
                
                if(selected) {
                    const val = parseInt(selected.value);
                    if(val === q.correct_index) {
                        correct++;
                        resEl.innerHTML = '<span class="text-green-600">Chính xác!</span>';
                        selected.parentElement.classList.add('bg-green-100');
                    } else {
                        resEl.innerHTML = '<span class="text-red-500">Sai rồi.</span>';
                        selected.parentElement.classList.add('bg-red-100');
                        // Highlight correct
                        document.getElementById(`rq_lbl_${idx}_${q.correct_index}`).classList.add('bg-green-50', 'border-green-300', 'border');
                    }
                } else {
                    resEl.innerHTML = '<span class="text-gray-400">Chưa làm.</span>';
                    document.getElementById(`rq_lbl_${idx}_${q.correct_index}`).classList.add('bg-green-50', 'border-green-300', 'border');
                }
                
                // Show Explanation
                expEl.classList.remove('hidden');
                document.getElementById(`rq_hint_${idx}`).style.display = 'block'; // Show hint box too as full review
            });
            
            showToast(`Bạn đúng ${correct}/${currentReadingData.questions.length} câu.`);
            document.getElementById('btnCheckReading').classList.add('hidden');
        }

        function exportReadingToWord() {
            if(!currentReadingData) return alert("Chưa có bài đọc.");
            
            let content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>Reading Export</title>
                <style>body {font-family: 'Times New Roman'; line-height: 1.5;} .q {margin-bottom: 15px;} .ans {color: green; font-weight: bold;}</style>
                </head>
                <body>
                    <h1>English Master - Reading Task</h1>
                    <h2>${currentReadingData.title}</h2>
                    <p>${currentReadingData.passage.replace(/\n/g, '<br>')}</p>
                    <hr>
                    <h3>Questions</h3>
            `;
            
            currentReadingData.questions.forEach((q, i) => {
                content += `<div class='q'><b>Q${i+1}: ${q.question}</b><br>`;
                q.options.forEach((opt, oi) => {
                    content += `${String.fromCharCode(65+oi)}. ${opt}<br>`;
                });
                content += `</div>`;
            });
            
            content += `<br><hr><h3>Answer Key & Explanations</h3>`;
            
            currentReadingData.questions.forEach((q, i) => {
                 content += `<p><b>Q${i+1}: ${String.fromCharCode(65+q.correct_index)}</b><br>`;
                 content += `<i>Keywords:</i> ${q.guide.keywords}<br>`;
                 content += `<i>Explanation:</i> ${q.guide.explanation}</p>`;
            });
            
            content += `</body></html>`;
            
            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Reading_Test_${Date.now()}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportReadingToExcel() {
             const txt = document.getElementById('readingDisplay').innerText.replace('Reading Passage', '');
             const level = document.getElementById('exportLevelReading').value;
             exportDeepDrillString(txt, level);
        }

        // ... [Rest of Audio/Gen/TTS code] ...

        // --- AUDIO GEN & TTS ---
        function setAudioGenMode(mode) {
            audioGenSettings.mode = mode;
            document.getElementById('inputTopicArea').classList.add('hidden');
            document.getElementById('inputTextArea').classList.add('hidden');
            document.getElementById('inputExamArea').classList.add('hidden');
            
            // Reset Buttons
            document.getElementById('btnModeTopic').className = "flex-1 py-2 border-2 border-gray-200 text-gray-500 rounded-lg font-bold text-sm hover:border-pink-300 transition";
            document.getElementById('btnModeText').className = "flex-1 py-2 border-2 border-gray-200 text-gray-500 rounded-lg font-bold text-sm hover:border-pink-300 transition";
            document.getElementById('btnModeExam').className = "flex-1 py-2 border-2 border-gray-200 text-gray-500 rounded-lg font-bold text-sm hover:border-pink-300 transition";

            if(mode === 'topic') {
                document.getElementById('inputTopicArea').classList.remove('hidden');
                document.getElementById('btnModeTopic').className = "flex-1 py-2 border-2 border-pink-500 bg-pink-50 text-pink-700 rounded-lg font-bold text-sm transition";
            } else if (mode === 'text') {
                document.getElementById('inputTextArea').classList.remove('hidden');
                document.getElementById('btnModeText').className = "flex-1 py-2 border-2 border-pink-500 bg-pink-50 text-pink-700 rounded-lg font-bold text-sm transition";
            } else if (mode === 'exam') {
                document.getElementById('inputExamArea').classList.remove('hidden');
                document.getElementById('btnModeExam').className = "flex-1 py-2 border-2 border-pink-500 bg-pink-50 text-pink-700 rounded-lg font-bold text-sm transition";
            }
        }

        async function executeAudioGeneration() {
            let text = "";
            const voice = document.getElementById('genVoice').value;
            const accent = document.getElementById('genAccent').value;

            if (audioGenSettings.mode === 'topic') {
                const topic = document.getElementById('genTopic').value.trim();
                const duration = document.getElementById('genDuration').value;
                const level = document.getElementById('genDifficulty').value;
                if(!topic) return alert("Vui lòng nhập chủ đề.");
                showLoader("Đang viết kịch bản...");
                try {
                    const prompt = `Write a speech on: "${topic}". Level: ${level}. Length: ~${duration*140} words. No intro tags.`;
                    const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                    text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch(e) { hideLoader(); return alert("Lỗi Gen Script: " + e.message); }
            } else if (audioGenSettings.mode === 'exam') {
                audioGenSettings.exam = document.getElementById('examType').value;
                audioGenSettings.part = document.getElementById('examPart').value;
                const topic = document.getElementById('examTopic').value.trim();
                
                showLoader("Đang soạn đề thi...");
                try {
                    const prompt = `Write a realistic ${audioGenSettings.exam} Listening Part ${audioGenSettings.part} transcript about "${topic}".
                    For Part 1/3 (Conversation): Generate a dialogue between speakers.
                    For Part 2/4 (Monologue): Generate a speech/talk.
                    Ensure the length is sufficient (at least 300 words for advanced).
                    Make it suitable for audio generation. No actor instructions like [laughing].`;
                    const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                    text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch(e) { hideLoader(); return alert("Lỗi Gen Exam Script: " + e.message); }
            } else {
                text = document.getElementById('genText').value.trim();
            }
            
            if(!text) return alert("Thiếu văn bản.");
            showLoader("Đang tạo giọng đọc...");
            
            // --- NEW: Handle Long Text Splitting for Audio ---
            // Gemini TTS has a limit (approx 4096 chars or lower depending on encoding). We safely chunk at ~3000 chars.
            const MAX_CHUNK_LENGTH = 3000;
            
            try {
                let audioBase64Result = "";
                
                if (text.length <= MAX_CHUNK_LENGTH) {
                    audioBase64Result = await callGeminiTTS(text, voice, accent);
                } else {
                    // Split text into chunks by sentences
                    showLoader("Văn bản dài: Đang xử lý từng phần...");
                    const chunks = splitTextForTTS(text, MAX_CHUNK_LENGTH);
                    const audioChunks = [];
                    
                    for (let i = 0; i < chunks.length; i++) {
                        showLoader(`Đang tạo giọng đọc (${i+1}/${chunks.length})...`);
                        const chunkAudio = await callGeminiTTS(chunks[i], voice, accent);
                        audioChunks.push(chunkAudio);
                    }
                    
                    showLoader("Đang ghép nối file âm thanh...");
                    audioBase64Result = concatenateAudioBase64(audioChunks);
                }
                
                const wavBlob = pcmToWav(audioBase64Result);
                const wavUrl = URL.createObjectURL(wavBlob);
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentAudioBase64 = reader.result.split(',')[1];
                    currentMimeType = "audio/wav";
                    resetAppStateForNewFile(wavUrl, "Audio_Generated_by_AI.wav");
                    targetText.value = text; hasTranscript = true;
                    
                    downloadAudioBtn.href = wavUrl;
                    downloadAudioBtn.classList.remove('hidden');

                    closeAudioGenModal(); switchTab('dictation'); hideLoader(); showToast("Đã tạo Audio!");
                    setTimeout(() => togglePlay(), 500);
                };
                reader.readAsDataURL(wavBlob);
            } catch(e) { hideLoader(); alert("Lỗi TTS: " + e.message); }
        }

        // Helper to split text smartly
        function splitTextForTTS(text, maxLength) {
            const sentences = text.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [text];
            const chunks = [];
            let currentChunk = "";
            
            sentences.forEach(s => {
                if ((currentChunk + s).length > maxLength) {
                    if (currentChunk) chunks.push(currentChunk.trim());
                    currentChunk = s;
                } else {
                    currentChunk += " " + s;
                }
            });
            if (currentChunk) chunks.push(currentChunk.trim());
            return chunks;
        }

        // Helper to concatenate Base64 PCM (16-bit)
        function concatenateAudioBase64(b64Chunks) {
            // 1. Decode all base64 to binary strings
            const binaryChunks = b64Chunks.map(b64 => window.atob(b64));
            // 2. Concatenate binary strings
            const combinedBinary = binaryChunks.join('');
            // 3. Re-encode to base64
            return window.btoa(combinedBinary);
        }

        async function callGeminiTTS(text, voiceName, accent) {
            let finalText = text;
            // Guide the model to use an accent via prompting
            if (accent === 'British') {
                finalText = `Speak with a British English accent: ${text}`;
            } else if (accent === 'Australian') {
                finalText = `Speak with an Australian English accent: ${text}`;
            } else if (accent === 'Indian') {
                finalText = `Speak with an Indian English accent: ${text}`;
            }

            const data = await callGeminiAPI('gemini-2.5-flash-preview-tts', {
                contents: [{ parts: [{ text: finalText }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } } } }
            });
            return data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        }

        function pcmToWav(base64PCM) {
            const binary = window.atob(base64PCM);
            const bytes = new Uint8Array(binary.length);
            for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const pcm = new Int16Array(bytes.buffer);
            const buffer = new ArrayBuffer(44 + pcm.length * 2);
            const view = new DataView(buffer);
            const writeString = (view, offset, str) => { for(let i=0; i<str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcm.length*2, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, 24000, true);
            view.setUint32(28, 24000*2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, pcm.length*2, true);
            for(let i=0; i<pcm.length; i++) view.setInt16(44+i*2, pcm[i], true);
            return new Blob([view], { type: 'audio/wav' });
        }

        // --- APP LOGIC ---
        function resetAppStateForNewFile(src, name) {
            hasTranscript = false; targetText.value = ""; userTyping.value = ""; quizData = []; transcriptData = [];
            document.getElementById('wordCount').innerText = "0 từ";
            document.getElementById('scoreBadge').classList.add('hidden');
            document.getElementById('aiResultDictation').classList.add('hidden');
            diffOutput.innerHTML = '';
            document.getElementById('dictationResultPanel').classList.remove('flex');
            document.getElementById('dictationResultPanel').classList.add('hidden');
            
            transcriptContent.innerHTML = '';
            transcriptPlaceholder.classList.remove('hidden');
            
            // Clear VI translation
            document.getElementById('transcriptTranslation').innerHTML = '';
            document.getElementById('transcriptTranslation').classList.add('hidden');
            
            quizContent.classList.add('hidden'); document.getElementById('questionsList').innerHTML = '';
            audio.src = src; fileNameDisplay.innerText = name; isPlaying = false; updatePlayButton(); progressBar.style.width = '0%';
            
            if (name === "Audio_Generated_by_AI.wav") {
                downloadAudioBtn.href = src;
                downloadAudioBtn.classList.remove('hidden');
            } else {
                downloadAudioBtn.classList.add('hidden');
            }
        }

        function switchTab(tab) {
            ['Dictation', 'Deep', 'Quiz', 'Reading', 'Writing', 'Pronun', 'Grammar', 'Vocab'].forEach(t => {
                const tabEl = document.getElementById(`tab${t}`);
                if(tabEl) {
                    const baseClass = "px-4 py-2 transition whitespace-nowrap text-sm sm:text-base";
                    if(t.toLowerCase() === tab) {
                        tabEl.className = `tab-active ${baseClass}`;
                    } else {
                        tabEl.className = `tab-inactive ${baseClass}`;
                    }
                }
                const view = document.getElementById(`view${t}`);
                if(view) {
                    if(t.toLowerCase()===tab) view.classList.remove('hidden'); else view.classList.add('hidden');
                }
            });
            const player = document.getElementById('audioPlayerBar');
            const uploadBtn = document.getElementById('audioUploadContainer');
            
            if(tab === 'reading' || tab === 'writing' || tab === 'deep' || tab === 'pronun' || tab === 'grammar' || tab === 'vocab') { 
                player.style.display = 'none'; 
                uploadBtn.style.display = 'none'; 
            } else { 
                player.style.display = 'block'; 
                uploadBtn.style.display = 'flex'; 
            }
            
            if(tab === 'deep') initSpeechRecognition();
        }

        // --- LISTENING QUIZ GENERATION ---
        async function generateQuiz() {
            if(!transcriptData.length && !targetText.value) return alert("Cần có Transcript trước để tạo câu hỏi.");
            
            const btn = document.getElementById('btnGenQuiz');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            
            const text = targetText.value;
            let prompt = "";

            if (audioGenSettings.mode === 'exam') {
                prompt = `Based on this transcript, generate 5 multiple-choice questions for ${audioGenSettings.exam} Listening Part ${audioGenSettings.part}.
                Transcript: "${text.substring(0, 3000)}..."
                Requirements:
                - Questions must follow the strict format of ${audioGenSettings.exam}.
                - Provide specific hints: "timestamp_hint" (e.g., 'Nghe đoạn 0:30-0:45') and "reasoning_hint" (Vietnamese explanation of how to infer the answer).
                Output JSON Array: [{ "q": "Question?", "options": ["A","B","C","D"], "correct": 0, "hint": { "time": "...", "logic": "..." } }]`;
            } else {
                // Casual/Topic Mode
                prompt = `Generate 3 comprehension questions based on this text: "${text.substring(0, 2000)}...". 
                Output JSON Array: [{ "q": "Question?", "options": ["A","B","C","D"], "correct": 0 }]`;
            }

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let txt = getSafeText(data).replace(/```json/g, '').replace(/```/g, '').trim();
                quizData = JSON.parse(txt);
                
                renderQuiz();
                showToast("Đã tạo câu hỏi Listening!");
            } catch(e) {
                alert("Lỗi tạo Quiz: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-bolt mr-2 text-yellow-300"></i> Tạo câu hỏi ngay';
            }
        }

        function renderQuiz() {
            document.getElementById('quizGenerator').classList.add('hidden');
            const content = document.getElementById('quizContent');
            content.classList.remove('hidden');
            document.getElementById('quizCountBadge').innerText = `${quizData.length} câu`;
            
            const list = document.getElementById('questionsList');
            list.innerHTML = '';
            
            quizData.forEach((q, i) => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-200";
                
                let opts = "";
                q.options.forEach((o, idx) => {
                    opts += `<label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" name="q${i}" value="${idx}" class="form-radio text-indigo-600">
                        <span class="text-gray-700 text-sm">${o}</span>
                    </label>`;
                });

                let hintBtn = "";
                let hintBox = "";
                if (q.hint) {
                    hintBtn = `<button onclick="document.getElementById('l_hint_${i}').classList.toggle('hidden')" class="text-xs text-orange-600 font-bold hover:text-orange-800"><i class="far fa-lightbulb mr-1"></i> Gợi ý</button>`;
                    hintBox = `<div id="l_hint_${i}" class="hidden mt-2 p-2 bg-orange-50 border-l-2 border-orange-300 text-xs text-gray-600">
                        <div><i class="fas fa-clock mr-1"></i> ${q.hint.time || 'N/A'}</div>
                        <div class="mt-1 italic">${q.hint.logic || '...'}</div>
                    </div>`;
                }

                item.innerHTML = `
                    <div class="font-bold text-gray-800 mb-2 flex justify-between">
                        <span>${i+1}. ${q.q}</span>
                        ${hintBtn}
                    </div>
                    <div class="space-y-1">${opts}</div>
                    ${hintBox}
                    <div id="res_q${i}" class="mt-2 text-sm font-bold"></div>
                `;
                list.appendChild(item);
            });
        }

        function checkQuizAll() {
            let score = 0;
            quizData.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                const res = document.getElementById(`res_q${i}`);
                if(selected) {
                    if(parseInt(selected.value) === q.correct) {
                        score++;
                        res.innerHTML = '<span class="text-green-600">Đúng!</span>';
                    } else {
                        res.innerHTML = `<span class="text-red-500">Sai. Đáp án: ${q.options[q.correct]}</span>`;
                    }
                } else res.innerHTML = '<span class="text-gray-400">Chưa làm</span>';
                
                // Show hint logic explanation after checking regardless
                if(q.hint) document.getElementById(`l_hint_${i}`)?.classList.remove('hidden');
            });
            showToast(`Kết quả: ${score}/${quizData.length}`);
        }

        // ... [Rest of existing functions from provided file: renderGrammarTree, etc.] ...

        // --- GRAMMAR MODULE FUNCTIONS ---
        
        function renderGrammarTree() {
            const container = document.getElementById('grammarTreeContainer');
            if(!container) return;
            container.innerHTML = '';

            GRAMMAR_TREE.forEach((section, index) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mb-3';
                sectionDiv.innerHTML = `
                    <div class="grammar-section-header font-bold ${section.color} ${section.bg} p-2 rounded flex justify-between items-center" onclick="toggleGrammarSection('gsec_${index}')">
                        <span>${section.title}</span>
                        <i class="fas fa-chevron-down transform transition-transform" id="icon_gsec_${index}"></i>
                    </div>
                    <div id="gsec_${index}" class="mt-1 space-y-1">
                        ${section.children.map(item => `
                            <div class="grammar-tree-item flex items-start">
                                <input type="checkbox" id="gchk_${item.id}" value="${item.title}" class="grammar-checkbox mt-1 mr-2 cursor-pointer">
                                <label for="gchk_${item.id}" class="cursor-pointer hover:text-red-700">
                                    <div class="font-semibold text-gray-700">${item.title}</div>
                                    <div class="text-[10px] text-gray-400 italic leading-tight">${item.desc}</div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(sectionDiv);
            });
        }

        function toggleGrammarSection(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(`icon_${id}`);
            el.classList.toggle('hidden');
            if(el.classList.contains('hidden')) icon.classList.add('-rotate-90');
            else icon.classList.remove('-rotate-90');
        }

        // NEW: Vocab Enrichment Tool Logic
        function handleVocabToolUpload(event) {
            const file = event.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                rawVocabToolData = e.target.result;
                document.getElementById('vocabToolFileName').innerText = file.name;
            };
            reader.readAsText(file);
        }

        async function generateEnrichedCSV() {
            if(!rawVocabToolData) return alert("Vui lòng chọn file trước.");
            
            const btn = document.getElementById('btnVocabToolAction');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
            
            const contentToProcess = rawVocabToolData.split('\n').slice(0, 100).join('\n'); 

            const prompt = `
            Task: Enrich this vocabulary list.
            Input: A list of words (one per line).
            Output: A CSV format with exactly 4 columns: Word, Vietnamese Meaning, English Definition, IPA.
            
            Rules:
            1. Use semicolons (;) to separate multiple meanings/definitions. NEVER use commas inside a field.
            2. First line must be header: Word,Vietnamese,English,IPA
            3. Provide accurate IPA and meanings.
            
            Input Data:
            ${contentToProcess}
            `;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let csvText = getSafeText(data).replace(/```csv/g, '').replace(/```/g, '').trim();
                
                downloadCSV(csvText, `Enriched_Vocab_${Date.now()}.csv`);
                showToast("Đã tạo và tải xuống CSV 4 cột!");
            } catch(e) {
                alert("Lỗi AI: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Xử lý & Tải về';
            }
        }

        function handleGrammarVocabUpload(event) {
            const file = event.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split(/\r?\n/);
                const words = [];
                rows.forEach(row => {
                    const cols = row.split(',');
                    if(cols[0] && cols[0].toLowerCase() !== 'word' && cols[0].trim().length > 1) {
                        words.push(cols[0].trim());
                    }
                });
                
                const shuffled = words.sort(() => 0.5 - Math.random());
                grammarVocabList = shuffled.slice(0, 50);
                
                document.getElementById('grammarVocabStatus').innerText = `Đã tải: ${words.length} từ`;
                document.getElementById('grammarVocabStatus').classList.remove('text-gray-400');
                document.getElementById('grammarVocabStatus').classList.add('text-green-600', 'font-bold');
                showToast(`Đã import ${words.length} từ vựng! AI sẽ ưu tiên dùng chúng.`);
            };
            reader.readAsText(file);
        }

        async function generateGrammarQuiz(retryTopics = null) {
            let selectedTopics = [];
            
            if (retryTopics) {
                selectedTopics = Array.from(retryTopics);
                showToast(`Đang tạo bài tập cải thiện (${selectedTopics.length} chủ điểm)...`);
            } else {
                const checkboxes = document.querySelectorAll('.grammar-checkbox:checked');
                checkboxes.forEach(cb => selectedTopics.push(cb.value));
                if(selectedTopics.length === 0) return alert("Vui lòng chọn ít nhất 1 chủ điểm ngữ pháp!");
            }

            const level = document.getElementById('grammarLevel').value;
            const btn = document.getElementById('btnGenGrammar');
            const originalBtnText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> AI đang soạn đề...';
            showLoader("AI đang soạn 20 câu hỏi ngữ pháp...");

            let vocabInstruction = "";
            if (grammarVocabList.length > 0) {
                vocabInstruction = `\nIMPORTANT: Try to integrate these vocabulary words into the questions or options where natural: [${grammarVocabList.join(', ')}].`;
            }

            const prompt = `Generate 20 multiple-choice grammar questions for English learners.
            Level: ${level}.
            Topics: ${selectedTopics.join(', ')}.${vocabInstruction}
            Output STRICT JSON format (Array of objects):
            [
              {
                "q": "Sentence with blank...",
                "options": ["A", "B", "C", "D"],
                "correct": 0, (index 0-3)
                "hint": "Short grammar rule explanation in Vietnamese",
                "topic": "Topic name (e.g., Past Simple)"
              },
              ...
            ]`;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let txt = getSafeText(data).replace(/```json/g, '').replace(/```/g, '').trim();
                
                try {
                    grammarQuizData = JSON.parse(txt);
                } catch(e) {
                    const firstBracket = txt.indexOf('[');
                    const lastBracket = txt.lastIndexOf(']');
                    if(firstBracket !== -1 && lastBracket !== -1) {
                        txt = txt.substring(firstBracket, lastBracket + 1);
                        grammarQuizData = JSON.parse(txt);
                    } else throw e;
                }

                if(!Array.isArray(grammarQuizData)) throw new Error("Format lỗi");

                renderGrammarQuestions();
                showToast("Đã tạo xong bài tập!");
                
                failedGrammarTopics.clear();
                
            } catch(e) {
                alert("Lỗi AI: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                hideLoader();
            }
        }

        function renderGrammarQuestions() {
            document.getElementById('grammarEmptyState').classList.add('hidden');
            const container = document.getElementById('grammarQuizContent');
            container.classList.remove('hidden');
            document.getElementById('grammarActionBar').classList.remove('hidden');
            document.getElementById('grammarActionBar').classList.add('flex');
            
            document.getElementById('btnCheckGrammar').classList.remove('hidden');
            document.getElementById('btnImproveGrammar').classList.add('hidden');
            document.getElementById('btnResetGrammar').classList.add('hidden');
            document.getElementById('grammarScore').innerText = "--/20";

            container.innerHTML = '';
            
            grammarQuizData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-lg shadow-sm border border-gray-200";
                card.id = `gq_card_${index}`;
                
                let optionsHtml = '';
                item.options.forEach((opt, idx) => {
                    optionsHtml += `
                        <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer transition gq-option-label" id="gq_lbl_${index}_${idx}">
                            <input type="radio" name="gq_${index}" value="${idx}" class="form-radio text-red-600 h-4 w-4">
                            <span class="text-gray-700">${opt}</span>
                        </label>
                    `;
                });

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">Câu ${index + 1}</span>
                        <span class="text-[10px] text-gray-400 font-mono bg-gray-50 px-2 rounded">${item.topic || 'General'}</span>
                    </div>
                    <div class="font-medium text-lg text-gray-800 mb-4">${item.q}</div>
                    <div class="space-y-2 mb-4">
                        ${optionsHtml}
                    </div>
                    <div class="flex items-center justify-between border-t border-gray-100 pt-3">
                        <button onclick="toggleGrammarHint(${index})" class="text-xs text-yellow-600 font-bold flex items-center hover:text-yellow-700">
                            <i class="far fa-lightbulb mr-1"></i> Gợi ý
                        </button>
                        <div id="gq_res_${index}" class="text-sm font-bold"></div>
                    </div>
                    <div id="gq_hint_${index}" class="hidden mt-2 p-2 bg-yellow-50 text-yellow-800 text-xs rounded italic border border-yellow-100">
                        ${item.hint}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleGrammarHint(idx) {
            document.getElementById(`gq_hint_${idx}`).classList.toggle('hidden');
        }

        function checkGrammarAnswers() {
            let correctCount = 0;
            failedGrammarTopics.clear();

            grammarQuizData.forEach((item, index) => {
                const selected = document.querySelector(`input[name="gq_${index}"]:checked`);
                const resEl = document.getElementById(`gq_res_${index}`);
                
                const inputs = document.querySelectorAll(`input[name="gq_${index}"]`);
                inputs.forEach(inp => inp.disabled = true);

                if (selected) {
                    const val = parseInt(selected.value);
                    const correctLbl = document.getElementById(`gq_lbl_${index}_${item.correct}`);
                    const selectedLbl = document.getElementById(`gq_lbl_${index}_${val}`);

                    if (val === item.correct) {
                        correctCount++;
                        resEl.innerHTML = '<span class="text-green-600"><i class="fas fa-check"></i> Chính xác</span>';
                        selectedLbl.classList.add('bg-green-50', 'border-green-200');
                    } else {
                        resEl.innerHTML = '<span class="text-red-500"><i class="fas fa-times"></i> Sai rồi</span>';
                        selectedLbl.classList.add('bg-red-50', 'border-red-200');
                        correctLbl.classList.add('bg-green-50', 'border-green-200', 'ring-1', 'ring-green-300'); // Highlight answer
                        
                        if(item.topic) failedGrammarTopics.add(item.topic);
                    }
                } else {
                    resEl.innerHTML = '<span class="text-gray-400">Chưa làm</span>';
                    if(item.topic) failedGrammarTopics.add(item.topic);
                    const correctLbl = document.getElementById(`gq_lbl_${index}_${item.correct}`);
                    correctLbl.classList.add('bg-green-50', 'border-green-200');
                }
            });

            document.getElementById('grammarScore').innerText = `${correctCount}/${grammarQuizData.length}`;
            
            document.getElementById('btnCheckGrammar').classList.add('hidden');
            if (failedGrammarTopics.size > 0) {
                document.getElementById('btnImproveGrammar').classList.remove('hidden');
            }
            document.getElementById('btnResetGrammar').classList.remove('hidden');
            
            showToast(`Hoàn thành! Bạn đúng ${correctCount}/${grammarQuizData.length} câu.`);
        }

        function handleImproveWeaknesses() {
            if(failedGrammarTopics.size === 0) return alert("Bạn đã làm đúng hết hoặc chưa nộp bài!");
            if(confirm(`Bạn có muốn tạo bộ đề mới tập trung vào: ${Array.from(failedGrammarTopics).join(', ')}?`)) {
                generateGrammarQuiz(failedGrammarTopics);
            }
        }

        function resetGrammarQuiz() {
            const container = document.getElementById('grammarQuizContent');
            const inputs = container.querySelectorAll('input[type="radio"]');
            inputs.forEach(inp => {
                inp.checked = false;
                inp.disabled = false;
            });
            
            const labels = container.querySelectorAll('.gq-option-label');
            labels.forEach(lbl => {
                lbl.classList.remove('bg-green-50', 'border-green-200', 'bg-red-50', 'border-red-200', 'ring-1', 'ring-green-300');
            });

            const results = container.querySelectorAll('div[id^="gq_res_"]');
            results.forEach(div => div.innerHTML = '');

            document.getElementById('grammarScore').innerText = "--/20";
            document.getElementById('btnCheckGrammar').classList.remove('hidden');
            document.getElementById('btnImproveGrammar').classList.add('hidden');
            document.getElementById('btnResetGrammar').classList.add('hidden');
        }

        // --- VOCABULARY MODULE ---
        
        function switchVocabType(type) {
            currentVocabType = type;
            const btnT = document.getElementById('btnVocabToeic');
            const btnI = document.getElementById('btnVocabIelts');
            
            if (type === 'TOEIC') {
                btnT.className = "flex-1 py-1.5 rounded text-xs font-bold bg-cyan-600 text-white shadow transition";
                btnI.className = "flex-1 py-1.5 rounded text-xs font-bold text-gray-500 hover:bg-gray-50 transition";
            } else {
                btnI.className = "flex-1 py-1.5 rounded text-xs font-bold bg-cyan-600 text-white shadow transition";
                btnT.className = "flex-1 py-1.5 rounded text-xs font-bold text-gray-500 hover:bg-gray-50 transition";
            }
            renderVocabTopics();
        }

        function renderVocabTopics() {
            const select = document.getElementById('vocabTopicSelect');
            select.innerHTML = '';
            
            VOCAB_TOPICS[currentVocabType].forEach(topic => {
                const opt = document.createElement('option');
                opt.value = topic.name;
                opt.innerText = topic.name;
                select.appendChild(opt);
            });
        }

        // NEW: Vocab CSV Upload Handler
        function handleVocabVocabUpload(event) {
            const file = event.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split(/\r?\n/);
                const words = [];
                rows.forEach(row => {
                    const cols = row.split(',');
                    // Simple parsing: assumes words are in the first column or just a list
                    if(cols[0] && cols[0].toLowerCase() !== 'word' && cols[0].trim().length > 1) {
                        words.push(cols[0].trim());
                    }
                });
                
                const shuffled = words.sort(() => 0.5 - Math.random());
                vocabVocabList = shuffled.slice(0, 50); // Take max 50 for prompt context
                
                document.getElementById('vocabVocabStatus').innerText = `Đã tải: ${words.length} từ`;
                document.getElementById('vocabVocabStatus').classList.remove('text-gray-400');
                document.getElementById('vocabVocabStatus').classList.add('text-green-600', 'font-bold');
                showToast(`Đã import ${words.length} từ vựng! AI sẽ ưu tiên dùng chúng.`);
            };
            reader.readAsText(file);
        }

        async function generateVocabQuiz() {
            const topic = document.getElementById('vocabTopicSelect').value;
            const level = document.getElementById('vocabLevel').value;
            
            const btn = document.getElementById('btnGenVocab');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo đề...';
            showLoader("AI đang soạn 15 câu hỏi từ vựng...");

            // Logic to include custom vocab
            let vocabInstruction = "";
            if (vocabVocabList.length > 0) {
                vocabInstruction = `\nIMPORTANT: Prioritize using these vocabulary words for questions or correct answers: [${vocabVocabList.join(', ')}].`;
            }

            const prompt = `Generate 15 vocabulary multiple-choice questions for ${currentVocabType}.
            Level: ${level}.
            Topic: ${topic}.${vocabInstruction}
            Output STRICT JSON format (Array of objects).
            Fields:
            - word (string): The key vocabulary word being tested.
            - meaning (string): Vietnamese meaning of the key word.
            - q (string): A sentence with a blank.
            - q_vi (string): Vietnamese translation of the sentence 'q'.
            - options (array): 4 choices (one is the key word or related).
            - correct (int): Index (0-3).
            - option_meanings (array): 4 Vietnamese meanings corresponding to the options.
            - collocations (string): Relevant fixed phrases, idioms, or grammatical structures related to the sentence/answer (e.g. "rely on", "look forward to").
            `;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let txt = getSafeText(data).replace(/```json/g, '').replace(/```/g, '').trim();
                
                try {
                     vocabQuizData = JSON.parse(txt);
                } catch(e) {
                     const firstBracket = txt.indexOf('[');
                     const lastBracket = txt.lastIndexOf(']');
                     if(firstBracket !== -1 && lastBracket !== -1) {
                         txt = txt.substring(firstBracket, lastBracket + 1);
                         vocabQuizData = JSON.parse(txt);
                     } else throw e;
                }

                renderVocabQuiz();
                showToast("Đã tạo đề từ vựng thành công!");

            } catch(e) {
                alert("Lỗi AI: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-bolt mr-2 text-yellow-300"></i> Tạo Đề (15 Câu)';
                hideLoader();
            }
        }

        function renderVocabQuiz() {
            document.getElementById('vocabEmptyState').classList.add('hidden');
            const container = document.getElementById('vocabQuizContent');
            container.classList.remove('hidden'); 
            container.innerHTML = '';
            document.getElementById('vocabActionBar').classList.remove('hidden');
            document.getElementById('vocabActionBar').classList.add('flex');
            
            // Reset state
            document.getElementById('btnCheckVocab').style.display = 'block';
            document.getElementById('vocabScore').innerText = '--/15';

            vocabQuizData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-lg shadow-sm border border-gray-200";
                
                let optionsHtml = '';
                item.options.forEach((opt, idx) => {
                    // Tooltip data
                    const meaning = item.option_meanings && item.option_meanings[idx] ? item.option_meanings[idx] : "Tra từ điển";
                    
                    optionsHtml += `
                        <label class="vocab-option relative flex items-center space-x-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer transition" data-meaning="${meaning}">
                            <input type="radio" name="vq_${index}" value="${idx}" class="form-radio text-cyan-600 h-4 w-4">
                            <span class="text-gray-700 font-medium">${opt}</span>
                        </label>
                    `;
                });

                // Hint Content
                const qVi = item.q_vi || "Chưa có dịch nghĩa";
                const colloc = item.collocations || "Không có cụm từ đặc biệt";

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="bg-cyan-100 text-cyan-800 text-xs font-bold px-2 py-1 rounded">Câu ${index + 1}</span>
                        <button onclick="document.getElementById('vq_hint_${index}').classList.toggle('hidden')" class="text-xs text-orange-600 font-bold hover:text-orange-800 flex items-center">
                             <i class="far fa-lightbulb mr-1"></i> Gợi ý
                        </button>
                    </div>
                    
                    <div id="vq_hint_${index}" class="hidden mb-3 p-3 bg-orange-50 rounded border border-orange-200 text-sm">
                        <div class="mb-1"><span class="font-bold text-orange-800">Dịch:</span> ${qVi}</div>
                        <div><span class="font-bold text-orange-800">Cấu trúc/Cụm từ:</span> ${colloc}</div>
                    </div>

                    <div class="font-medium text-lg text-gray-800 mb-4">${item.q}</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        ${optionsHtml}
                    </div>
                    <div id="vq_res_${index}" class="text-sm font-bold mt-2"></div>
                `;
                container.appendChild(card);
            });
        }

        function checkVocabAnswers() {
            let correctCount = 0;
            vocabQuizData.forEach((item, index) => {
                const selected = document.querySelector(`input[name="vq_${index}"]:checked`);
                const resEl = document.getElementById(`vq_res_${index}`);
                
                // Disable inputs
                const inputs = document.querySelectorAll(`input[name="vq_${index}"]`);
                inputs.forEach(inp => inp.disabled = true);

                if(selected) {
                    const val = parseInt(selected.value);
                    if (val === item.correct) {
                        correctCount++;
                        resEl.innerHTML = `<span class="text-green-600"><i class="fas fa-check"></i> Đúng (${item.word}: ${item.meaning})</span>`;
                        selected.parentElement.classList.add('bg-green-50', 'border-green-200');
                    } else {
                        resEl.innerHTML = `<span class="text-red-500"><i class="fas fa-times"></i> Sai. Đáp án: ${item.options[item.correct]} (${item.meaning})</span>`;
                        selected.parentElement.classList.add('bg-red-50', 'border-red-200');
                        // Highlight correct
                        const correctInput = document.querySelector(`input[name="vq_${index}"][value="${item.correct}"]`);
                        if(correctInput) correctInput.parentElement.classList.add('bg-green-50', 'border-green-200', 'ring-1', 'ring-green-300');
                    }
                } else {
                    resEl.innerHTML = `<span class="text-gray-500">Chưa làm. Đáp án: ${item.options[item.correct]}</span>`;
                }
            });

            document.getElementById('vocabScore').innerText = `${correctCount}/${vocabQuizData.length}`;
            document.getElementById('btnCheckVocab').style.display = 'none';
        }

        function exportVocabQuiz() {
            if (vocabQuizData.length === 0) return alert("Chưa có dữ liệu để xuất.");
            
            let csv = "Question,Correct Word,Meaning,Collocations,Translation\n";
            vocabQuizData.forEach(q => {
                // Sanitize content for CSV (remove commas/quotes)
                const safeQ = `"${q.q.replace(/"/g, '""')}"`;
                const safeWord = `"${q.word}"`;
                const safeMeaning = `"${q.meaning}"`;
                const safeColloc = `"${(q.collocations || '').replace(/"/g, '""')}"`;
                const safeTrans = `"${(q.q_vi || '').replace(/"/g, '""')}"`;
                
                csv += `${safeQ},${safeWord},${safeMeaning},${safeColloc},${safeTrans}\n`;
            });
            
            downloadCSV(csv, `Vocab_Quiz_Export_${Date.now()}.csv`);
        }

        // --- MAIN AUDIO PLAYER ---
        function handleAudioUpload(e) {
            const file = e.target.files[0]; if(!file) return;
            const url = URL.createObjectURL(file);
            resetAppStateForNewFile(url, file.name);
            const reader = new FileReader();
            reader.onload = () => { currentAudioBase64 = reader.result.split(',')[1]; currentMimeType = file.type; };
            reader.readAsDataURL(file);
            
            downloadAudioBtn.href = url;
            downloadAudioBtn.download = file.name;
            downloadAudioBtn.classList.remove('hidden');
        }
        function audioLoaded() { audioDuration = audio.duration; durationEl.innerText = formatTime(audioDuration); seekSlider.max = Math.floor(audioDuration); }
        function togglePlay() { if(!audio.src) return alert("Chưa có file audio."); if(isPlaying) audio.pause(); else audio.play(); isPlaying = !isPlaying; updatePlayButton(); }
        function updatePlayButton() { playBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play ml-1"></i>'; }
        
        function updateProgress() {
            const cur = audio.currentTime; 
            progressBar.style.width = `${(cur/audioDuration)*100}%`; 
            seekSlider.value = Math.floor(cur); 
            currentTimeEl.innerText = formatTime(cur);
            
            if(segmentEnd !== null && cur >= segmentEnd) { 
                audio.pause(); 
                isPlaying = false; 
                updatePlayButton(); 
                segmentEnd = null; 
                hintSegment.style.opacity = '0'; 
            }
            
            if(transcriptData.length > 0) {
                transcriptData.forEach((seg, i) => {
                    // English Sync
                    const elEn = document.getElementById(`ts_${i}`);
                    if (elEn) {
                        if(cur >= seg.start && cur <= seg.end) {
                            elEn.classList.add('t-active');
                            elEn.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                        } else {
                            elEn.classList.remove('t-active');
                        }
                    }

                    // Vietnamese Sync
                    const elVi = document.getElementById(`tv_${i}`);
                    if (elVi) {
                         if(cur >= seg.start && cur <= seg.end) {
                            elVi.classList.add('tv-active');
                            // Only scroll VI if visible to avoid double scroll jank
                            if(!document.getElementById('transcriptTranslation').classList.contains('hidden')) {
                                elVi.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                            }
                        } else {
                            elVi.classList.remove('tv-active');
                        }
                    }
                });
            }
        }
        
        function formatTime(s) { return `${Math.floor(s/60)}:${Math.floor(s%60)<10?'0':''}${Math.floor(s%60)}`; }
        function changeSpeed() { audio.playbackRate = parseFloat(document.getElementById('speedSelect').value); }
        function rewind(s) { audio.currentTime = Math.max(0, audio.currentTime-s); }
        function forward(s) { audio.currentTime = Math.min(audioDuration, audio.currentTime+s); }
        seekSlider.addEventListener('input', (e) => audio.currentTime = e.target.value);
        
        function playSegment(start, end) {
            if(!audio.src) return;
            let safeEnd = end - start < 5 ? Math.min(start+5, audioDuration) : end;
            hintSegment.style.left = `${(start/audioDuration)*100}%`; hintSegment.style.width = `${((safeEnd-start)/audioDuration)*100}%`; hintSegment.style.opacity = '0.7';
            audio.currentTime = start; segmentEnd = safeEnd; audio.play(); isPlaying = true; updatePlayButton();
        }
        
        function toggleLoop() {
             isLooping = document.getElementById('loopToggle').checked;
             showToast(isLooping ? "Đã bật tự động lặp lại" : "Đã tắt lặp lại");
        }

        function audioEnded() {
            if (isLooping) {
                audio.currentTime = 0;
                audio.play();
            } else {
                isPlaying = false;
                updatePlayButton();
            }
        }

        // --- DICTATION & REALTIME TRANSCRIPT ---
        function toggleTranscriptVisibility() {
            const wrapper = document.getElementById('transcriptWrapper');
            const mask = document.getElementById('transcriptHiddenMask');
            const btn = document.getElementById('btnToggleTranscript');

            if (wrapper.classList.contains('hidden')) {
                wrapper.classList.remove('hidden');
                mask.classList.add('hidden');
                btn.classList.add('bg-indigo-100', 'text-indigo-800');
                btn.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Ẩn Transcript';
            } else {
                wrapper.classList.add('hidden');
                mask.classList.remove('hidden');
                btn.classList.remove('bg-indigo-100', 'text-indigo-800');
                btn.innerHTML = '<i class="fas fa-eye mr-1"></i> Hiện Transcript';
            }
        }

        function toggleTranscriptLang(lang) {
            const contentEn = document.getElementById('transcriptContent');
            const contentVi = document.getElementById('transcriptTranslation');
            const btnEn = document.getElementById('btnTransEn');
            const btnVi = document.getElementById('btnTransVi');

            if (lang === 'en') {
                contentEn.classList.remove('hidden');
                contentVi.classList.add('hidden');
                
                btnEn.className = "text-[10px] px-2 py-0.5 rounded bg-white text-gray-800 font-bold shadow-sm transition";
                btnVi.className = "text-[10px] px-2 py-0.5 rounded text-gray-500 hover:text-gray-700 transition";
            } else {
                contentEn.classList.add('hidden');
                contentVi.classList.remove('hidden');
                
                btnVi.className = "text-[10px] px-2 py-0.5 rounded bg-white text-gray-800 font-bold shadow-sm transition";
                btnEn.className = "text-[10px] px-2 py-0.5 rounded text-gray-500 hover:text-gray-700 transition";
            }
        }

        async function generateTranscriptFromAI() {
            if(!currentAudioBase64) return alert("Chưa có audio.");
            showToast("Đang tạo Transcript & Dịch nghĩa...");
            
            const prompt = `Transcribe audio strictly into JSON segments. Include Vietnamese translation for each segment. 
            Format: [{"start":0.0,"end":2.5,"text":"Hello world", "vi": "Xin chào thế giới"}]. 
            Do not use markdown. Timestamps in seconds.`;
            
            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', {
                    contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: currentMimeType, data: currentAudioBase64 } }] }]
                });
                let txt = data.candidates?.[0]?.content?.parts?.[0]?.text;
                let segments = [];
                try {
                    txt = txt.replace(/```json/g, '').replace(/```/g, '').trim();
                    segments = JSON.parse(txt);
                } catch (parseErr) {
                    console.warn("JSON Parse failed, fallback");
                    segments = [{start: 0, end: audioDuration, text: txt, vi: "Không thể dịch tự động."}];
                }
                
                transcriptData = segments;
                renderRealtimeTranscript();
                targetText.value = segments.map(s => s.text).join(' ');
                hasTranscript = true; 
                
                // Show Transcript by default after generation
                if(document.getElementById('transcriptWrapper').classList.contains('hidden')) {
                     toggleTranscriptVisibility();
                }

                showToast("Đã tạo Transcript + Dịch nghĩa!");
            } catch(e) { alert("Lỗi Transcribe: " + e.message); }
        }

        function renderRealtimeTranscript() {
            transcriptPlaceholder.classList.add('hidden');
            const contentEn = document.getElementById('transcriptContent');
            const contentVi = document.getElementById('transcriptTranslation');
            
            contentEn.innerHTML = '';
            contentVi.innerHTML = '';
            
            transcriptData.forEach((seg, index) => {
                const spanEn = document.createElement('span');
                spanEn.id = `ts_${index}`;
                spanEn.className = 't-segment mr-1';
                spanEn.innerText = seg.text;
                spanEn.title = `Jump to ${formatTime(seg.start)}`;
                spanEn.onclick = () => {
                    audio.currentTime = seg.start;
                    audio.play();
                    isPlaying = true;
                    updatePlayButton();
                };
                contentEn.appendChild(spanEn);

                const divVi = document.createElement('div');
                divVi.id = `tv_${index}`; // Assign ID for Sync
                divVi.className = 'tv-segment mb-2 p-1 pl-2 hover:bg-indigo-50 transition cursor-pointer text-sm leading-relaxed';
                divVi.innerHTML = `<span class="text-[10px] font-mono text-gray-400 mr-2 select-none">${formatTime(seg.start)}</span>${seg.vi || "..."}`;
                divVi.onclick = () => {
                     audio.currentTime = seg.start;
                    audio.play();
                    isPlaying = true;
                    updatePlayButton();
                };
                contentVi.appendChild(divVi);
            });
        }

        function saveTranscript() { 
            if(targetText.value) { 
                hasTranscript = true; 
                const rawText = targetText.value;
                const sentences = rawText.match(/[^.!?]+[.!?]*/g) || [rawText];
                const totalDur = audioDuration > 0 ? audioDuration : 10;
                const avgDur = totalDur / sentences.length;
                
                transcriptData = sentences.map((s, i) => ({
                    start: i * avgDur,
                    end: (i + 1) * avgDur,
                    text: s.trim(),
                    vi: "(Thủ công - Chưa dịch)"
                }));
                
                renderRealtimeTranscript();
                closeSetupModal(); 
                showToast("Đã lưu và đồng bộ!"); 
            } 
        }

        function checkResult() {
            if(!hasTranscript) return alert("Chưa có Transcript.");
            const user = userTyping.value.trim(); const original = targetText.value.trim();
            const clean = s => s.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(/\s+/);
            const userArr = clean(user); const orgArr = clean(original);
            let match = 0;
            const uCopy = [...userArr];
            orgArr.forEach(w => { const idx = uCopy.indexOf(w); if(idx > -1) { match++; uCopy.splice(idx, 1); } });
            const score = Math.round((match/orgArr.length)*100);
            
            document.getElementById('dictationResultPanel').classList.remove('hidden');
            document.getElementById('dictationResultPanel').classList.add('flex');
            
            document.getElementById('scoreBadge').innerText = `${score}% Đúng`; document.getElementById('scoreBadge').classList.remove('hidden');
            diffOutput.innerHTML = renderDiff(original, user);
        }
        function renderDiff(org, usr) {
            const clean = s => s.trim().toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            const uWords = usr.split(/\s+/).map(clean);
            const uCounts = {}; uWords.forEach(w => uCounts[w] = (uCounts[w]||0)+1);
            return '<div class="leading-relaxed">' + org.split(/\s+/).map(w => {
                const cw = clean(w);
                if(cw && uCounts[cw] > 0) { uCounts[cw]--; return `<span class="text-green-600 font-bold mx-1 border-b-2 border-green-100">${w}</span>`; }
                return `<span class="text-gray-900 mx-1">${w}</span>`;
            }).join('') + '</div>';
        }
        function updateWordCount() { document.getElementById('wordCount').innerText = `${userTyping.value.split(/\s+/).length} từ`; }
        
        async function analyzeWithAI() {
            const btn = document.getElementById('btnAnalyze'); btn.disabled = true; btn.innerText = "...";
            const res = document.getElementById('aiResultDictation'); res.innerHTML = "AI is thinking..."; res.classList.remove('hidden');
            try {
                const prompt = `Analyze dictation errors. Original: "${targetText.value}". User: "${userTyping.value}". Explain major mistakes in Vietnamese.`;
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                res.innerHTML = data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/\n/g, '<br>') || "Lỗi.";
            } catch(e) { res.innerText = "Error: " + e.message; } finally { btn.disabled = false; btn.innerHTML = `<i class="fas fa-microscope mr-1"></i> Phân tích lỗi (AI)`; }
        }

        // --- WRITING MODULE ---
        function toggleWritingMode(mode) {
            const auto = document.getElementById('writeAutoUI'); const man = document.getElementById('writeManualUI');
            if(mode==='auto') { auto.classList.remove('hidden'); man.classList.add('hidden'); }
            else { auto.classList.add('hidden'); man.classList.remove('hidden'); }
        }

        const WRITE_TASKS = {
            "TOEIC": [
                {id: "email", name: "Write an Email (Part 2)"},
                {id: "essay", name: "Write an Essay (Part 3)"}
            ],
            "IELTS": [
                {id: "task1", name: "Task 1: Chart/Graph/Map"},
                {id: "task2", name: "Task 2: Essay"}
            ]
        };

        function updateWriteTasks() {
            const exam = document.getElementById('writeExamType').value;
            const select = document.getElementById('writeTaskType');
            select.innerHTML = '';
            WRITE_TASKS[exam].forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id; opt.innerText = t.name;
                select.appendChild(opt);
            });
        }
        
        async function generateWritingTopic() {
            const exam = document.getElementById('writeExamType').value;
            const task = document.getElementById('writeTaskType').value;
            const level = document.getElementById('writeLevel').value;
            
            const btn = document.getElementById('btnGenWriteTopic'); btn.disabled=true; btn.innerText = "Đang tạo...";
            
            const prompt = `Generate a realistic ${exam} Writing ${task} topic. Level: ${level}.
            Output TEXT ONLY. Do not wrap in quotes.
            Example format for Task 1: "The chart below shows..."
            Example format for Essay: "Some people believe that..."
            `;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                const topic = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                const d = document.getElementById('writingTopicDisplay'); 
                d.innerText=topic; 
                d.classList.remove('hidden');
                
                document.getElementById('btnGetHints').classList.remove('hidden');
                document.getElementById('btnGetOutline').classList.remove('hidden');
            } catch(e){alert("Lỗi: " + e.message);} finally { btn.disabled=false; btn.innerHTML = '<i class="fas fa-dice mr-1"></i> Tạo Đề Mới'; }
        }
        
        async function getWritingOutline() {
            const topic = document.getElementById('writingTopicDisplay').innerText || document.getElementById('writeManualInput').value;
            if(!topic) return alert("Chưa có đề bài.");
            
            const btn = document.getElementById('btnGetOutline'); btn.disabled = true; btn.innerText = "Đang tư duy...";
            const exam = document.getElementById('writeExamType').value;
            
            const prompt = `
            Act as an ${exam} Writing expert. For this topic: "${topic}", provide a detailed Thinking Process & Outline (Dàn ý) in Vietnamese.
            Structure:
            1. Brainstorming (Tìm ý): How to generate ideas?
            2. Structure (Bố cục): Intro, Body 1, Body 2, Conclusion.
            3. Key Vocabulary (Từ vựng ăn điểm).
            4. Thesis Statement / Overview sample.
            `;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                const html = data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                
                const h = document.getElementById('writingHints'); 
                h.innerHTML = `<div class="p-2 bg-orange-50 border-l-4 border-orange-400 text-sm">${html}</div>`; 
                h.classList.remove('hidden');
            } catch(e){ alert("Lỗi: " + e.message); } finally { btn.disabled = false; btn.innerText = "Lập Dàn Ý & Tư Duy (AI)"; }
        }

        async function getWritingHints() {
            const topic = document.getElementById('writingTopicDisplay').innerText || document.getElementById('writeManualInput').value;
            if(!topic) return alert("Chưa có topic.");
            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: `List 10 key vocabulary words/collocations for this topic: "${topic}". Vietnamese meanings.` }] }] });
                const h = document.getElementById('writingHints'); 
                const prev = h.innerHTML;
                h.innerHTML = prev + `<div class="mt-2 pt-2 border-t border-gray-200"><b>Từ vựng gợi ý:</b><br>${data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/\n/g,'<br>')}</div>`; 
                h.classList.remove('hidden');
            } catch(e){alert("Lỗi: " + e.message);}
        }

        async function evaluateWriting() {
            const topic = document.getElementById('writingTopicDisplay').innerText || document.getElementById('writeManualInput').value;
            const essay = document.getElementById('writingInput').value;
            const exam = document.getElementById('writeExamType').value;
            
            if(!essay) return alert("Chưa có bài viết.");
            
            const btn = document.getElementById('btnEvalWriting'); btn.innerText = "Đang chấm điểm..."; btn.disabled = true;
            
            const prompt = `Evaluate this ${exam} writing task.
            Topic: ${topic}
            Student Essay: ${essay}
            
            Task:
            1. Estimated Band Score (IELTS) or Score (TOEIC).
            2. Detailed feedback on Task Response, Coherence, Lexical Resource, Grammatical Range.
            3. Corrected version (list errors and fixes).
            Language: Vietnamese.
            `;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                document.getElementById('feedbackContent').innerHTML = data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                document.getElementById('writingFeedback').classList.remove('hidden');
            } catch(e) { alert("Lỗi: " + e.message); } finally { btn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Chấm điểm & Sửa lỗi'; btn.disabled = false; }
        }

        function downloadWritingWord() {
            const topic = document.getElementById('writingTopicDisplay').innerText || document.getElementById('writeManualInput').value;
            const essay = document.getElementById('writingInput').value.replace(/\n/g, '<br>');
            const feedback = document.getElementById('feedbackContent').innerHTML;
            
            if(!topic || !essay) return alert("Chưa có nội dung để tải.");

            const content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>Writing Task Export</title>
                <style>body {font-family: 'Times New Roman';}</style>
                </head>
                <body>
                    <h1>English Master - Writing Task</h1>
                    <h3>Đề bài:</h3>
                    <p>${topic}</p>
                    <hr>
                    <h3>Bài làm của bạn:</h3>
                    <p>${essay}</p>
                    <hr>
                    <h3>Đánh giá & Chấm điểm của AI:</h3>
                    <div>${feedback}</div>
                </body></html>
            `;

            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Writing_Feedback_${Date.now()}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ... [Rest of code remains unchanged] ...
        // Ensure functions like exportDeepDrill, etc are still available.

        // --- EXPORT TO DEEP DRILL ---
        async function exportDeepDrill(sourceId, levelId) {
            const text = document.getElementById(sourceId).value;
            const level = document.getElementById(levelId).value;
            if(!text || text.length < 50) return alert("Nội dung quá ngắn để trích xuất.");
            
            showLoader("Đang trích xuất từ vựng...");
            
            let levelPrompt = "CEFR B2-C2 (Advanced/Proficiency)";
            if(level === 'all') levelPrompt = "CEFR A1-C2 (All levels)";
            if(level === 'b1') levelPrompt = "CEFR B1-C2 (Intermediate to Advanced)";
            if(level === 'b2') levelPrompt = "CEFR B2-C2 (Advanced)";
            
            const prompt = `Analyze this text and extract 15-20 key vocabulary items... ${levelPrompt} ... OUTPUT STRICT CSV FORMAT... IMPORTANT: Use semicolons (;) to separate multiple meanings/definitions. Do NOT use commas inside a field.`;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });

                let csvContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
                csvContent = csvContent.replace(/```csv/g, '').replace(/```/g, '').trim();
                
                downloadCSV(csvContent, `DeepDrill_Export_${Date.now()}.csv`);
                showToast("Đã tải xuống file CSV!");
            } catch(e) {
                alert("Lỗi trích xuất: " + e.message);
            } finally {
                hideLoader();
            }
        }
        
        function exportDeepDrillFromReading() {
            const txt = document.getElementById('readingDisplay').innerText.replace('Reading Passage', '');
            const level = document.getElementById('exportLevelReading').value;
            exportDeepDrillString(txt, level);
        }

        async function exportDeepDrillString(text, levelCode) {
            if(!text || text.length < 50) return alert("Nội dung quá ngắn.");
            showLoader("Đang trích xuất từ vựng...");
            let levelPrompt = "CEFR B2-C2";
            if(levelCode === 'all') levelPrompt = "CEFR A1-C2";
            if(levelCode === 'b1') levelPrompt = "CEFR B1-C2";
            if(levelCode === 'b2') levelPrompt = "CEFR B2-C2";
            
            const prompt = `Analyze text, extract 15 key words (${levelPrompt}). Output CSV (No Header): Word/Phrase, VN Meaning, Eng Def, IPA. Use semicolons (;) for multiple meanings. Do NOT use commas inside a column. Text: ${text.substring(0, 3000)}`;
            
            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });

                let csvContent = data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```csv/g, '').replace(/```/g, '').trim();
                downloadCSV(csvContent, `DeepDrill_Reading_${Date.now()}.csv`);
                showToast("Đã tải xuống CSV!");
            } catch(e) { alert("Lỗi: " + e.message); } finally { hideLoader(); }
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- DEEP DRILL MODULE ---
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US'; 
                recognition.interimResults = false; 
                recognition.maxAlternatives = 1;
                
                recognition.onstart = () => { 
                    isRecording = true; 
                    const btn = document.getElementById('btnDeepSpeak');
                    if(btn) btn.classList.add('bg-purple-100', 'pulse-ring'); 
                    const txt = document.getElementById('btnDeepSpeakText');
                    if(txt) txt.innerText = "Đang nghe..."; 
                };
                
                recognition.onend = () => { 
                    isRecording = false; 
                    const btn = document.getElementById('btnDeepSpeak');
                    if(btn) btn.classList.remove('bg-purple-100', 'pulse-ring'); 
                    const txt = document.getElementById('btnDeepSpeakText');
                    if(txt) txt.innerText = "Bấm để nói"; 
                };
                
                recognition.onerror = (event) => {
                    isRecording = false;
                    const txt = document.getElementById('btnDeepSpeakText');
                    if(txt) txt.innerText = "Lỗi Mic (Thử lại)";
                    const btn = document.getElementById('btnDeepSpeak');
                    if(btn) btn.classList.remove('bg-purple-100', 'pulse-ring');
                };

                recognition.onresult = (e) => checkDeepPronunciation(e.results[0][0].transcript);
            }
        }

        function toggleDeepSpeech() {
            if(!recognition) {
                initSpeechRecognition();
                if(!recognition) return alert("Trình duyệt của bạn không hỗ trợ Speech API.");
            }
            if(isRecording) { recognition.stop(); } else { try { recognition.start(); } catch(e) { console.error(e); alert("Lỗi Mic."); } }
        }

        function checkDeepPronunciation(spoken) {
            const target = deepSessionData[deepCurrentGroup]?.challenges[deepCurrentChallenge]?.text;
            if(!target) return;
            const resDiv = document.getElementById('deepSpeechResult'); resDiv.classList.remove('hidden');
            const clean = s => s.toLowerCase().replace(/[^a-z0-9]/g, "");
            if(clean(spoken) === clean(target)) {
                document.getElementById('deepSpeechFeedback').innerHTML = `<span class="text-green-600">✅ Chính xác!</span>`;
                document.getElementById('deepSpokenText').innerText = spoken;
            } else {
                document.getElementById('deepSpeechFeedback').innerHTML = `<span class="text-red-500">❌ Thử lại!</span>`;
                document.getElementById('deepSpokenText').innerText = spoken;
            }
        }
        
        function handleDeepFileUpload(e) {
            const file = e.target.files[0]; if(!file) return;
            deepFileName = file.name;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const parsed = parseDeepCSV(evt.target.result);
                if(parsed.length > 0) {
                    processDeepData(parsed);
                    showToast(`Đã tải ${parsed.length} nhóm từ.`);
                } else alert("File lỗi hoặc rỗng.");
            };
            reader.readAsText(file);
        }
        function parseDeepCSV(text) {
            const rows = []; let row = []; let cell = ""; let inQuote = false;
            for(let i=0; i<text.length; i++) {
                const c = text[i]; const n = text[i+1];
                if(c === '"') { if(inQuote && n === '"') { cell += '"'; i++; } else inQuote = !inQuote; }
                else if(c === ',' && !inQuote) { row.push(cell.trim()); cell = ""; }
                else if((c === '\r' || c === '\n') && !inQuote) { 
                    if(c==='\r' && n==='\n') i++; row.push(cell.trim()); 
                    if(row.length) rows.push(row); row = []; cell = ""; 
                } else cell += c;
            }
            if(cell) row.push(cell.trim()); if(row.length) rows.push(row);
            
            const result = [];
            for(let r of rows) {
                if(r.length < 3) continue; // Allow at least 3 columns
                result.push({ w: r[0], m: r[1], s: r[2], p: r[3]||"" });
            }
            return result;
        }
        function processDeepData(rawData) {
            deepSessionData = rawData.map(row => {
                const challenges = [];
                challenges.push({ 
                    text: row.w, 
                    type: 'WORD', 
                    meaning: row.m, 
                    root: row.w, 
                    ipa: row.p, 
                    engDef: row.s 
                });
                return { challenges };
            }).filter(g => g);
            
            const saved = localStorage.getItem(`deep_prog_${deepFileName}`);
            if(saved) {
                const p = JSON.parse(saved);
                if(confirm("Tiếp tục tiến độ cũ?")) { deepCurrentGroup = p.g; deepScore = p.s; }
                else { deepCurrentGroup = 0; deepScore = {correct:0, wrong:0}; }
            } else { deepCurrentGroup = 0; deepScore = {correct:0, wrong:0}; }
            
            startDeepSession();
        }
        function startDeepSession() {
            document.getElementById('deepEmptyState').classList.add('hidden');
            document.getElementById('deepGameArea').classList.remove('hidden');
            document.getElementById('deepEndScreen').classList.add('hidden');
            document.getElementById('btnDeepReset').classList.remove('hidden');
            loadDeepChallenge();
        }
        function loadDeepChallenge() {
            if(!deepSessionData[deepCurrentGroup]) { finishDeepSession(); return; }
            const group = deepSessionData[deepCurrentGroup];
            if(deepCurrentChallenge >= group.challenges.length) deepCurrentChallenge = 0;
            const chal = group.challenges[deepCurrentChallenge];
            
            deepIsRetrying = false;
            document.getElementById('deepGroupCounter').innerText = `${deepCurrentGroup+1}/${deepSessionData.length}`;
            document.getElementById('deepJumpInput').value = deepCurrentGroup + 1; 
            document.getElementById('deepJumpInput').max = deepSessionData.length;
            
            document.getElementById('deepProgressBar').style.width = `${(deepCurrentGroup/deepSessionData.length)*100}%`;
            document.getElementById('deepScoreCorrect').innerText = deepScore.correct;
            document.getElementById('deepScoreWrong').innerText = deepScore.wrong;
            
            const inp = document.getElementById('deepInput');
            inp.value = ""; inp.disabled = false; inp.focus();
            document.getElementById('deepLargeResult').innerHTML = "";
            document.getElementById('deepFeedbackArea').classList.add('hidden');
            document.getElementById('deepHintArea').classList.add('hidden');
            document.getElementById('deepSpeechResult').classList.add('hidden');
            
            document.getElementById('btnDeepCheck').classList.remove('hidden');
            document.getElementById('btnDeepSkip').classList.remove('hidden');
            document.getElementById('btnDeepNext').classList.add('hidden');
            
            const badge = document.getElementById('deepTypeBadge');
            badge.innerText = "TỪ VỰNG";
            badge.className = "inline-block px-3 py-1 rounded-full text-xs font-bold bg-indigo-100 text-indigo-800";
            
            renderDeepDots(group.challenges.length, deepCurrentChallenge);
            setTimeout(() => playDeepAudio(), 500);
            
            localStorage.setItem(`deep_prog_${deepFileName}`, JSON.stringify({ g: deepCurrentGroup, s: deepScore }));
        }
        function renderDeepDots(total, current) {
            let h = "";
            for(let i=0; i<total; i++) {
                if(i<current) h += `<div class="w-2 h-2 rounded-full bg-green-500 m-0.5"></div>`;
                else if(i===current) h += `<div class="w-3 h-3 rounded-full bg-purple-600 border-2 border-purple-200 m-0.5"></div>`;
                else h += `<div class="w-2 h-2 rounded-full bg-gray-300 m-0.5"></div>`;
            }
            document.getElementById('deepStepDots').innerHTML = h;
        }
        function playDeepAudio() {
            const txt = deepSessionData[deepCurrentGroup].challenges[deepCurrentChallenge].text;
            const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-US'; u.rate = 0.9;
            window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
        }
        function handleDeepSubmit(e) { e.preventDefault(); if(document.getElementById('btnDeepNext').classList.contains('hidden')) checkDeepAnswer(); else nextDeepChallenge(); }
        
        function checkDeepAnswer() {
            const chal = deepSessionData[deepCurrentGroup].challenges[deepCurrentChallenge];
            const val = document.getElementById('deepInput').value.trim();
            const correct = val.toLowerCase() === chal.text.toLowerCase();
            
            if(correct) {
                if(!deepIsRetrying) deepScore.correct++;
                revealDeepAnswer(true);
            } else {
                if(!deepIsRetrying) { deepScore.wrong++; deepIsRetrying = true; }
                const inp = document.getElementById('deepInput');
                inp.classList.add('border-red-500', 'bg-red-50', 'shake');
                setTimeout(()=>inp.classList.remove('shake'), 500);
            }
            document.getElementById('deepScoreCorrect').innerText = deepScore.correct;
            document.getElementById('deepScoreWrong').innerText = deepScore.wrong;
        }

        function skipDeepChallenge() {
            if(!deepIsRetrying) { deepScore.wrong++; deepIsRetrying = true; }
            document.getElementById('deepScoreWrong').innerText = deepScore.wrong;
            revealDeepAnswer(false);
        }

        function revealDeepAnswer(isCorrect) {
            const chal = deepSessionData[deepCurrentGroup].challenges[deepCurrentChallenge];
            const inp = document.getElementById('deepInput');
            inp.disabled = true;
            
            if(isCorrect) {
                inp.classList.add('border-green-500', 'bg-green-50', 'text-green-800');
                const ipaHtml = chal.ipa ? `<span class="block text-xs text-gray-400 font-mono mt-1">${chal.ipa}</span>` : "";
                document.getElementById('deepLargeResult').innerHTML = `<div class="text-center pop-in"><span class="text-2xl font-extrabold text-green-600">${chal.text}</span>${ipaHtml}</div>`;
            } else {
                const ipaHtml = chal.ipa ? `<span class="block text-xs text-red-300 font-mono mt-1">${chal.ipa}</span>` : "";
                document.getElementById('deepLargeResult').innerHTML = `<div class="text-center pop-in"><span class="text-xs text-red-400 font-bold uppercase">ĐÁP ÁN:</span><br><span class="text-xl font-bold text-red-600">${chal.text}</span>${ipaHtml}</div>`;
            }
            
            showDeepFeedback(chal);
            playDeepAudio();
            document.getElementById('btnDeepCheck').classList.add('hidden');
            document.getElementById('btnDeepSkip').classList.add('hidden');
            document.getElementById('btnDeepNext').classList.remove('hidden'); 
            document.getElementById('btnDeepNext').focus();
        }

        function showDeepFeedback(chal) {
            const fb = document.getElementById('deepFeedbackArea'); fb.classList.remove('hidden');
            document.getElementById('deepMeaningDisplay').innerText = chal.meaning;
            document.getElementById('deepRootRow').classList.add('hidden');
            
            if(chal.engDef) {
                document.getElementById('deepSynonymSection').classList.remove('hidden');
                document.getElementById('deepSynonymList').innerHTML = `<li class="text-sm italic text-gray-600">${chal.engDef}</li>`;
            } else document.getElementById('deepSynonymSection').classList.add('hidden');
        }
        function nextDeepChallenge() {
            if(deepCurrentChallenge < deepSessionData[deepCurrentGroup].challenges.length - 1) {
                deepCurrentChallenge++; loadDeepChallenge();
            } else {
                if(deepCurrentGroup < deepSessionData.length - 1) {
                    deepCurrentGroup++; deepCurrentChallenge = 0; loadDeepChallenge();
                } else finishDeepSession();
            }
        }
        function finishDeepSession() {
            document.getElementById('deepGameArea').classList.add('hidden');
            document.getElementById('deepEndScreen').classList.remove('hidden');
            document.getElementById('deepProgressBar').style.width = '100%';
            localStorage.removeItem(`deep_prog_${deepFileName}`);
        }
        function toggleDeepHint() {
            const chal = deepSessionData[deepCurrentGroup].challenges[deepCurrentChallenge];
            document.getElementById('deepHintArea').classList.toggle('hidden');
            if (chal.ipa) {
                document.getElementById('deepHintText').innerText = `IPA: ${chal.ipa}`;
            } else {
                const txt = chal.text;
                document.getElementById('deepHintText').innerText = `Gợi ý: ${txt.charAt(0)}...${txt.charAt(txt.length-1)}`;
            }
        }
        
        function jumpToDeepChallenge(val) {
            let idx = parseInt(val) - 1;
            if (isNaN(idx) || idx < 0) idx = 0;
            if (idx >= deepSessionData.length) idx = deepSessionData.length - 1;
            
            deepCurrentGroup = idx;
            deepCurrentChallenge = 0; 
            loadDeepChallenge();
        }

        function deepRestart() { deepCurrentGroup=0; deepCurrentChallenge=0; deepScore={correct:0,wrong:0}; startDeepSession(); }
        function deepResetProgress() { if(confirm("Xóa tiến độ?")) { localStorage.removeItem(`deep_prog_${deepFileName}`); deepRestart(); } }

        // --- PRONUNCIATION / SPEAKING MODULE ---

        function toggleSpeakingMode() {
            const type = document.getElementById('pronunType').value;
            const drillControls = document.getElementById('drillControls');
            const testControls = document.getElementById('testControls');
            const drillGrid = document.getElementById('pronunGrid');
            const testInterface = document.getElementById('speakingTestInterface');
            const empty = document.getElementById('pronunEmpty');

            if (type.includes('speak')) { // Test mode
                drillControls.classList.add('hidden');
                testControls.classList.remove('hidden');
                drillGrid.classList.add('hidden');
                testInterface.classList.add('hidden'); // Initially hidden until generated
                empty.classList.remove('hidden');
                document.getElementById('pronunEmpty').querySelector('p').innerText = "Nhập chủ đề và nhấn 'Bắt đầu thi' để AI tạo đề.";
            } else { // Drill mode
                drillControls.classList.remove('hidden');
                testControls.classList.add('hidden');
                testInterface.classList.add('hidden');
                empty.classList.remove('hidden');
                document.getElementById('pronunEmpty').querySelector('p').innerText = "Chọn loại bài tập và nhấn 'Tạo bài tập' để bắt đầu.";
            }
        }

        async function generatePronunciationDrill() {
            const type = document.getElementById('pronunType').value;
            const count = 3; 
            const historyStr = pronunciationHistory.join(", ");
            const btn = document.getElementById('btnGenPronun');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            showLoader("AI đang tìm dữ liệu phát âm...");

            let prompt = "";
            if (type === 'pairs') {
                prompt = `Generate ${count} unique minimal pairs (words that sound similar but are different) for English learners. Exclude: [${historyStr}]. Output JSON: [{"words": ["ship", "sheep"], "ipa": ["ʃɪp", "ʃiːp"], "meanings": ["tàu", "cừu"], "desc": "Short i vs Long i"}]`;
            } else if (type === 'triplets') {
                prompt = `Generate ${count} unique groups of 3 words that sound similar. Exclude: [${historyStr}]. Output JSON: [{"words": ["there", "their", "they're"], "ipa": ["ðer", "ðer", "ðer"], "meanings": ["đó", "của họ", "họ là"], "desc": "Homophones"}]`;
            } else if (type === 'special') {
                prompt = `Generate ${count} groups of English words that are notoriously difficult to pronounce or have silent letters. Output JSON: [{"words": ["colonel", "choir"], "ipa": ["ˈkɜːrnəl", "ˈkwaɪər"], "meanings": ["đại tá", "dàn hợp xướng"], "desc": "Difficult Words"}]`;
            } else if (type === 'ending_s') {
                prompt = `Generate ${count} groups of words demonstrating the 3 sounds of -s/-es endings (/s/, /z/, /ɪz/). Each group should have 6-8 examples mixed. Output JSON: [{"words": ["cats", "dogs", "boxes"], "ipa": ["kæts", "dɒgz", "bɒksɪz"], "meanings": ["mèo", "chó", "hộp"], "desc": "/s/ vs /z/ vs /ɪz/"}]`;
            } else if (type === 'ending_ed') {
                prompt = `Generate ${count} groups of words demonstrating the 3 sounds of -ed endings (/t/, /d/, /ɪd/). Each group should have 6-8 examples mixed. Output JSON: [{"words": ["talked", "played", "wanted"], "ipa": ["tɔːkt", "pleɪd", "wɒntɪd"], "meanings": ["nói", "chơi", "muốn"], "desc": "/t/ vs /d/ vs /ɪd/"}]`;
            }

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                
                let txt = getSafeText(data).replace(/```json/g, '').replace(/```/g, '').trim();
                let json;
                try {
                    json = JSON.parse(txt);
                } catch (e) {
                    throw new Error("Lỗi đọc dữ liệu từ AI. Vui lòng thử lại.");
                }

                if (!Array.isArray(json)) {
                    throw new Error("Dữ liệu trả về không đúng định dạng danh sách.");
                }
                
                pronunciationData = json;
                
                json.forEach(item => {
                    if (item.words && Array.isArray(item.words)) {
                        item.words.forEach(w => pronunciationHistory.push(w));
                    }
                });
                
                renderPronunciationDrill();
                showToast("Đã tạo bài tập mới!");
            } catch(e) {
                alert("Lỗi AI: " + e.message);
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Tạo bài tập (AI)';
                hideLoader();
            }
        }

        function renderPronunciationDrill() {
            const grid = document.getElementById('pronunGrid');
            const empty = document.getElementById('pronunEmpty');
            const testInterface = document.getElementById('speakingTestInterface');
            
            testInterface.classList.add('hidden'); // Ensure test interface is hidden
            if(!pronunciationData || pronunciationData.length === 0) {
                empty.classList.remove('hidden');
                grid.classList.add('hidden');
                return;
            }

            empty.classList.add('hidden');
            grid.classList.remove('hidden');
            grid.innerHTML = '';
            
            // Adjust grid layout based on item count to avoid squeezing
            // Default: 1 col mobile, 2 tablet, 3 desktop
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";

            const type = document.getElementById('pronunType').value;
            const isSpecialFormat = (type === 'ending_s' || type === 'ending_ed' || type === 'triplets');

            if (isSpecialFormat) {
                 // For S/ES/ED and Triplets, force fewer columns to give more space
                 grid.className = "grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-6";
            }

            pronunciationData.forEach((group, groupIdx) => {
                let cardsHtml = '';
                if (group.words && Array.isArray(group.words)) {
                    group.words.forEach((word, wordIdx) => {
                        const ipa = (group.ipa && group.ipa[wordIdx]) ? group.ipa[wordIdx] : '';
                        const meaning = (group.meanings && group.meanings[wordIdx]) ? group.meanings[wordIdx] : '';
                        
                        cardsHtml += `
                            <div class="flex flex-col items-center p-3 bg-gray-50 rounded-lg border border-gray-100 relative h-full min-w-[100px] flex-1">
                                <span class="text-xl font-bold text-gray-800 break-words text-center">${word}</span>
                                <span class="text-sm text-gray-500 font-mono mb-1">/${ipa}/</span>
                                <span class="text-xs text-indigo-600 font-medium mb-3 text-center min-h-[1.2rem] leading-tight">${meaning}</span>
                                <div class="flex space-x-2 mt-auto">
                                    <button onclick="playWord('${word}')" class="w-8 h-8 rounded-full bg-teal-100 text-teal-700 hover:bg-teal-200 flex items-center justify-center transition shadow-sm" title="Nghe mẫu">
                                        <i class="fas fa-volume-up text-xs"></i>
                                    </button>
                                    <button onclick="checkPronunciation('${word}', 'pronunRes_${groupIdx}_${wordIdx}')" class="w-8 h-8 rounded-full bg-white border border-gray-300 text-gray-600 hover:text-teal-600 hover:border-teal-400 flex items-center justify-center transition shadow-sm" title="Kiểm tra giọng">
                                        <i class="fas fa-microphone text-xs"></i>
                                    </button>
                                </div>
                                <div id="pronunRes_${groupIdx}_${wordIdx}" class="mt-2 h-4 text-[10px] font-bold text-center w-full"></div>
                            </div>
                        `;
                    });

                    // Conditional Header rendering based on user request ("bỏ hàng chữ xanh")
                    let headerHtml = '';
                    if (!isSpecialFormat) {
                        headerHtml = `<div class="text-xs font-bold text-teal-600 uppercase mb-3 tracking-wide border-b border-gray-100 pb-2">${group.desc || 'Minimal Pair'}</div>`;
                    }

                    const card = document.createElement('div');
                    // FIX: Ensure grid layout inside the card for S/ES/ED/Triplets
                    const innerGridClass = isSpecialFormat ? "grid grid-cols-2 md:grid-cols-4 gap-4" : "flex flex-row gap-4 overflow-x-auto pb-2";

                    card.className = "bg-white p-5 rounded-xl shadow-md border border-gray-100 pronun-card";
                    card.innerHTML = `
                        ${headerHtml}
                        <div class="${innerGridClass}">
                            ${cardsHtml}
                        </div>
                    `;
                    grid.appendChild(card);
                }
            });
        }

        async function generateSpeakingTest() {
            const type = document.getElementById('pronunType').value;
            const topic = document.getElementById('speakTopic').value || "General";
            const btn = document.getElementById('btnGenSpeakTest');
            
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';
            showLoader("AI đang soạn đề thi Speaking...");
            
            let prompt = "";
            if (type === 'toeic_speak') {
                prompt = `Generate a short TOEIC Speaking Test (New Format) on topic "${topic}". Include 4 questions covering: 1. Describe a picture (simulate with text description), 2. Respond to questions, 3. Propose a solution, 4. Express an opinion. For each question, provide: "question", "thinking_process" (Vietnamese), "speaking_strategy" (Vietnamese), "sample_ideas" (Vietnamese bullet points). Output JSON Array.`;
            } else {
                prompt = `Generate an IELTS Speaking Test Simulation on topic "${topic}". Include 3 parts: Part 1 (Introduction), Part 2 (Cue Card), Part 3 (Discussion). For each part, provide: "question", "thinking_process" (Vietnamese), "speaking_strategy" (Vietnamese), "sample_ideas" (Vietnamese bullet points). Output JSON Array.`;
            }

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let txt = getSafeText(data).replace(/```json/g, '').replace(/```/g, '').trim();
                speakingTestData = JSON.parse(txt);
                
                renderSpeakingTest(type);
            } catch(e) {
                alert("Lỗi AI: " + e.message);
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-play-circle mr-2"></i> Bắt đầu thi';
                hideLoader();
            }
        }

        function renderSpeakingTest(type) {
            const grid = document.getElementById('pronunGrid');
            const empty = document.getElementById('pronunEmpty');
            const testInterface = document.getElementById('speakingTestInterface');
            const container = document.getElementById('speakQuestionArea');
            const typeLabel = document.getElementById('speakTestTypeLabel');

            empty.classList.add('hidden');
            grid.classList.add('hidden');
            testInterface.classList.remove('hidden');
            
            typeLabel.innerText = type === 'toeic_speak' ? "TOEIC SPEAKING TEST" : "IELTS SPEAKING TEST";
            container.innerHTML = '';

            speakingTestData.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md";
                div.innerHTML = `
                    <div class="flex items-start mb-4">
                        <div class="flex-shrink-0 bg-purple-100 text-purple-700 font-bold w-8 h-8 rounded-full flex items-center justify-center mr-3 mt-1 text-sm shadow-sm">${idx+1}</div>
                        <div class="flex-1">
                             <div class="font-bold text-gray-800 text-lg leading-snug">${q.question.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    
                    <div class="ml-11 mb-4 flex space-x-2">
                        <button onclick="document.getElementById('speakHint_${idx}').classList.toggle('hidden')" class="text-xs font-bold text-orange-600 bg-orange-50 hover:bg-orange-100 border border-orange-200 px-3 py-1.5 rounded-full transition flex items-center">
                            <i class="far fa-lightbulb mr-1.5"></i> Gợi ý & Chiến thuật
                        </button>
                    </div>

                    <div id="speakHint_${idx}" class="hidden ml-11 mb-6 bg-orange-50 p-4 rounded-lg text-sm text-gray-700 border-l-4 border-orange-400 shadow-inner">
                        <div class="mb-2"><strong class="text-orange-800 uppercase text-xs tracking-wide">Thinking Process:</strong><br>${q.thinking_process}</div>
                        <div class="mb-2"><strong class="text-orange-800 uppercase text-xs tracking-wide">Strategy:</strong><br>${q.speaking_strategy}</div>
                        <div><strong class="text-orange-800 uppercase text-xs tracking-wide">Ideas:</strong><br>${q.sample_ideas}</div>
                    </div>

                    <div class="ml-11">
                        <div class="relative">
                            <textarea id="speakAnswer_${idx}" class="w-full p-4 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-100 focus:outline-none text-base mb-3 shadow-inner bg-gray-50 transition" rows="3" placeholder="Nhập câu trả lời của bạn ở đây..."></textarea>
                            <div class="absolute bottom-5 right-2 text-xs text-gray-400 pointer-events-none">Rec/Type</div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="recordSpeakingAnswer(${idx})" id="btnRecord_${idx}" class="flex-1 md:flex-none bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center shadow-sm">
                                <i class="fas fa-microphone mr-2 text-red-500"></i> Thu âm (Mic)
                            </button>
                            <button onclick="submitSpeakingAnswer(${idx})" id="btnSubmit_${idx}" class="flex-1 md:flex-none bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center shadow-md transform active:scale-95">
                                <i class="fas fa-paper-plane mr-2"></i> Chấm điểm AI
                            </button>
                        </div>
                        <div id="speakResult_${idx}" class="hidden mt-4 p-4 bg-green-50 rounded-lg border border-green-200 text-sm shadow-sm animate-fade-in-up"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function recordSpeakingAnswer(idx) {
             if (!window.SpeechRecognition && !window.webkitSpeechRecognition) return alert("Trình duyệt không hỗ trợ.");
             const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
             const rec = new SR();
             rec.lang = 'en-US';
             const btn = document.getElementById(`btnRecord_${idx}`);
             const area = document.getElementById(`speakAnswer_${idx}`);
             
             btn.classList.add('bg-red-100', 'text-red-600', 'animate-pulse', 'border-red-300');
             btn.innerHTML = '<i class="fas fa-stop mr-2"></i> Đang nghe...';
             
             rec.start();
             
             rec.onresult = (e) => {
                 const txt = e.results[0][0].transcript;
                 area.value = txt;
             };
             
             rec.onend = () => {
                 btn.classList.remove('bg-red-100', 'text-red-600', 'animate-pulse', 'border-red-300');
                 btn.classList.add('bg-white', 'text-gray-700');
                 btn.innerHTML = '<i class="fas fa-microphone mr-2 text-red-500"></i> Thu âm (Mic)';
             };
        }

        async function submitSpeakingAnswer(idx) {
            const question = speakingTestData[idx].question;
            const answer = document.getElementById(`speakAnswer_${idx}`).value;
            const resultDiv = document.getElementById(`speakResult_${idx}`);
            const btn = document.getElementById(`btnSubmit_${idx}`);
            
            if(!answer) return alert("Vui lòng nhập câu trả lời.");
            
            btn.disabled = true; btn.innerText = "Đang chấm...";
            
            const prompt = `Evaluate this Speaking answer.
            Question: "${question}"
            User Answer: "${answer}"
            Output JSON: {
                "score": "Score (0-10 or Band)",
                "feedback": "Vietnamese feedback on grammar/vocab/fluency",
                "better_version": "A better way to say it (English)"
            }`;

            try {
                const data = await callGeminiAPI('gemini-2.5-flash-preview-09-2025', { contents: [{ parts: [{ text: prompt }] }] });
                let txt = getSafeText(data).replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(txt);
                
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2 pb-2 border-b border-green-200">
                        <span class="font-bold text-green-800 text-lg">Điểm: ${json.score}</span>
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                    </div>
                    <div class="text-gray-700 mb-3 leading-relaxed"><b>Nhận xét:</b> ${json.feedback}</div>
                    <div class="bg-white p-3 rounded border border-purple-100 text-purple-800 text-sm">
                        <div class="font-bold text-xs uppercase text-purple-400 mb-1">Gợi ý cách nói hay hơn:</div>
                        <i class="fas fa-quote-left text-purple-300 mr-2"></i>${json.better_version}
                    </div>
                `;
            } catch(e) {
                alert("Lỗi AI: " + e.message);
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Chấm điểm AI';
            }
        }

        function playWord(word) {
            const u = new SpeechSynthesisUtterance(word);
            u.lang = 'en-US';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }

        function checkPronunciation(targetWord, resultElemId) {
            if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                return alert("Trình duyệt không hỗ trợ Speech API.");
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = 'en-US';
            rec.interimResults = false;
            rec.maxAlternatives = 1;

            const resEl = document.getElementById(resultElemId);
            resEl.innerHTML = '<i class="fas fa-spinner fa-spin text-teal-500"></i>';

            rec.onstart = () => {};
            rec.onend = () => {};
            rec.onerror = (e) => { resEl.innerHTML = '<span class="text-red-500">Lỗi Mic</span>'; };
            
            rec.onresult = (e) => {
                const spoken = e.results[0][0].transcript.toLowerCase().replace(/[^a-z0-9]/g, "");
                const target = targetWord.toLowerCase().replace(/[^a-z0-9]/g, "");
                
                if (spoken === target) {
                    resEl.innerHTML = '<span class="text-green-600"><i class="fas fa-check"></i> Đúng!</span>';
                } else {
                    resEl.innerHTML = `<span class="text-red-500" title="Bạn nói: ${spoken}">Sai (${spoken})</span>`;
                }
            };
            
            rec.start();
        }

        function exportPronunciation() {
            if (pronunciationData.length === 0) return alert("Chưa có dữ liệu để xuất.");
            
            let csv = "Group ID,Description,Word,IPA,Meaning\n"; 
            pronunciationData.forEach((group, idx) => {
                group.words.forEach((w, wIdx) => {
                    const safeDesc = (group.desc || "").replace(/,/g, " ");
                    const meaning = (group.meanings && group.meanings[wIdx]) ? group.meanings[wIdx].replace(/,/g, "; ") : "";
                    csv += `${idx + 1},"${safeDesc}","${w}","${group.ipa[wIdx]}","${meaning}"\n`;
                });
            });
            
            downloadCSV(csv, `Pronunciation_Drill_${Date.now()}.csv`);
        }

    </script>
</body>
</html>